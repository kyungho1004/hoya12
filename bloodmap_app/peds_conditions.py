
# -*- coding: utf-8 -*-
"""
peds_conditions.py
- 소아 보호자 친화형 '병명별 안내' 데이터와 유틸리티
- 참고용 안내이며 최종 판단은 의료진의 몫입니다.
"""
from typing import Dict, List, Optional

KST_NOTE = "⏱ 한국시간(KST) 기준 안내입니다."
DISCLAIMER = ("⚠️ 이 페이지의 내용은 보호자 참고용입니다. "
              "아이 상태가 빠르게 나빠지거나, 보호자의 직감으로 '이상하다'고 느껴지면 즉시 의료진과 상의하세요.")

# 질환별 기본 안내 데이터
# 각 항목: title, quick, home, caution, when_clinic, when_er, myths
CONDITIONS: Dict[str, Dict[str, List[str]]] = {
    "수족구병": {
        "title": ["수족구병 (Hand-Foot-Mouth Disease)"],
        "quick": [
            "대개 바이러스성, 손/발/입 안 수포(물집)와 발진이 특징.",
            "고열이 2~3일 지속될 수 있으나 보통 5~7일 내 호전."
        ],
        "home": [
            "실내 25~26℃로 유지, 가벼운 옷차림(반바지 등).",
            "수분을 '소량·자주' 제공: 물/ORS/과일주스(희석), 얼음조각/젤리도 가능.",
            "손발이 따뜻하면 대개 해열 진행 중, 차가우면 아직 해열 전일 수 있음."
        ],
        "caution": [
            "구강 통증으로 탈수 위험: 소변 횟수/양 감소 시 주의.",
            "수포를 터뜨리지 말 것(2차 감염 위험).",
            "해열제 과다 복용 금지(성분 중복 주의)."
        ],
        "when_clinic": [
            "열이 3일 이상 지속되거나 통증으로 수분 섭취가 어려울 때.",
            "입 주변이 심하게 헐어 음식을 거의 못 먹는 경우."
        ],
        "when_er": [
            "하루 이상 소변량이 뚜렷히 줄거나, 매우 처지며 깨우기 어려움.",
            "연속 구토/피 섞인 구토·변, 호흡 곤란, 경련."
        ],
        "myths": [
            "입안 '혈점/돌기'만으로 수족구를 단정하지 마세요. 손·발 수포/발진 동반 여부가 더 중요합니다."
        ]
    },
    "바이러스성 장염": {
        "title": ["바이러스성 장염 (로타/노로 등)"],
        "quick": [
            "구토와 물설사, 복통, 미열/발열이 흔함.",
            "대부분 3~5일 내 호전. 탈수 관리가 핵심."
        ],
        "home": [
            "구토 초기엔 5~10분 간격으로 티스푼 단위 수분(ORS/물)을 천천히.",
            "설사 중에도 '수분·전해질 보충'이 가장 중요.",
            "지속 설사 중엔 우유/유제품이 더부룩함을 유발할 수 있어 일시 제한 고려."
        ],
        "caution": [
            "혈변, 콜레라 같이 물 같은 심한 설사, 고열 지속 시 주의.",
            "항생제는 대부분 도움이 되지 않음(바이러스 원인)."
        ],
        "when_clinic": [
            "구토/설사가 3일 이상 지속, 소변량 감소.",
            "복통이 심해 울거나 보채는 시간이 길어짐."
        ],
        "when_er": [
            "연속 구토로 물도 못 넘김, 의식저하/심한 처짐.",
            "검은변/선홍색 혈변, 탈수로 입마름·눈물 감소·소변 거의 없음."
        ],
        "myths": [
            "설사 중엔 물을 '일단 중단'해야 한다는 오해가 있습니다. 오히려 소량씩 자주 보충해야 합니다."
        ]
    },
    "편도/인후염": {
        "title": ["편도/인후염 (세균·바이러스)"],
        "quick": [
            "목 통증, 연하곤란, 발열. 일부는 연쇄상구균(항생제 필요)."
        ],
        "home": [
            "실내 25~26℃, 가습/미지근한 물, 차갑거나 부드러운 음식(요거트, 아이스크림).",
            "해열제는 연령·체중에 맞게."
        ],
        "caution": [
            "항생제는 의사 판단 하에 복용(불필요한 항생제는 해로울 수 있음)."
        ],
        "when_clinic": [
            "3일 이상 고열, 침도 삼키기 힘들 정도의 통증.",
            "편도 주위 부종/편도주위농양 의심(구개편위, 입 벌리기 힘듦)."
        ],
        "when_er": [
            "호흡 곤란, 심한 탈수, 기력 저하로 보행 곤란."
        ],
        "myths": [
            "목감기=항생제 라는 공식은 없습니다. 상당수는 바이러스성입니다."
        ]
    },
    "중이염": {
        "title": ["중이염"],
        "quick": [
            "감기 뒤 귀 통증/열. 일부는 저절로 호전, 일부 항생제 필요."
        ],
        "home": [
            "통증 조절(해열진통제), 충분한 수분/휴식."
        ],
        "caution": [
            "귀에서 고름/혈성 분비물 있으면 의료진 상담.",
            "항생제는 진단 후 결정."
        ],
        "when_clinic": [
            "열이 48~72시간 지속, 통증 심해지는 경우.",
            "반복성 중이염/청력 저하 의심."
        ],
        "when_er": [
            "심한 처짐, 고열 지속 + 다른 경고 증상 동반."
        ],
        "myths": [
            "모든 귀통증이 즉시 항생제를 의미하진 않습니다."
        ]
    },
    "기관지염/천식악화": {
        "title": ["기관지염/천식 악화"],
        "quick": [
            "기침, 쌕쌕거림(천명), 흉부 답답함.",
            "감기 후 악화되는 경우 흔함."
        ],
        "home": [
            "의사가 처방한 흡입제/기관지확장제 사용법을 그대로 따르기.",
            "가습/수분 섭취, 자극적 냄새 피하기."
        ],
        "caution": [
            "기침이 밤에 심해 수면 방해, 말이 짧아짐/숨 참(호흡곤란) 시 주의."
        ],
        "when_clinic": [
            "증상 3일 이상 지속/악화, 흡입제 사용 횟수 증가."
        ],
        "when_er": [
            "말문 짧아짐, 늑간함몰/콧벌렁임, 청색증, 산소포화도 저하."
        ],
        "myths": [
            "기침=항생제는 아닙니다. 대개 바이러스/기도과민 때문."
        ]
    },
    "독감(인플루엔자)": {
        "title": ["독감(인플루엔자)"],
        "quick": [
            "고열, 두통/근육통, 기침. 항바이러스제는 초기에 효과가 큼(의사 판단)."
        ],
        "home": [
            "해열/수분/휴식. 학교·어린이집은 해열 후 24시간 이상 지나고 컨디션 회복되면 복귀."
        ],
        "caution": [
            "영유아·만성질환·면역저하 아동은 합병증 위험↑."
        ],
        "when_clinic": [
            "고열 3일 이상, 기침·호흡곤란 악화."
        ],
        "when_er": [
            "호흡 곤란, 의식저하/경련, 심한 탈수."
        ],
        "myths": [
            "독감과 일반 감기는 다릅니다. 갑작스런 전신통이 특징."
        ]
    },
    "코로나19(소아)": {
        "title": ["코로나19 (소아)"],
        "quick": [
            "발열/기침/콧물/인후통, 대개 경증이나 드물게 호흡기 합병증."
        ],
        "home": [
            "해열·수분·휴식, 격리 수칙 준수(지역 지침 참조)."
        ],
        "caution": [
            "기저질환/면역저하는 조기 진료 권고."
        ],
        "when_clinic": [
            "3일 이상 고열, 기침·호흡곤란 악화."
        ],
        "when_er": [
            "호흡 곤란/청색증, 처짐 심함, 경련."
        ],
        "myths": [
            "소아는 항상 가볍다는 보장은 없습니다. 경고 신호는 즉시 진료."
        ]
    },
    "요로감염(UTI)": {
        "title": ["요로감염 (UTI)"],
        "quick": [
            "고열만 보이는 경우도 있음(특히 영아). 배뇨통/빈뇨/복통 동반 가능."
        ],
        "home": [
            "수분 충분히, 변비 관리(요로감염과 연관)."
        ],
        "caution": [
            "항생제는 의사 진단 후 복용. 지연되면 신우신염 위험."
        ],
        "when_clinic": [
            "고열, 배뇨 관련 증상 지속. 소변 검사 필요."
        ],
        "when_er": [
            "처짐 심하고 물도 못 마심, 반복 구토/고열 지속."
        ],
        "myths": [
            "배뇨통이 없어도 UTI일 수 있습니다(특히 영아)."
        ]
    },
    "구내염(항암치료 연관 포함)": {
        "title": ["구내염 (항암치료 연관 포함)"],
        "quick": [
            "입안 궤양/통증으로 식사·수분 섭취 저하, 발열 동반 가능."
        ],
        "home": [
            "처방받은 가글 사용, 자극적 음식 피하기(맵고 뜨거운 것).",
            "차갑고 부드러운 음식 위주(요거트/푸딩/아이스크림).",
            "약국 생리식염수는 1주 이상 지속 사용 금지."
        ],
        "caution": [
            "면역저하/호중구감소 시 감염 위험 높음 → 발열 동반 시 병원 연락.",
            "구내염 통증으로 탈수 위험."
        ],
        "when_clinic": [
            "2~3일 내 호전 없거나 통증으로 음식·물 섭취 크게 감소."
        ],
        "when_er": [
            "발열 + 처짐/의식 변화, 하루 이상 소변량 감소, 연속 구토."
        ],
        "myths": [
            "모든 구내염이 칸디다성은 아닙니다. 자의적 항진균제 사용은 금물."
        ]
    }
}

def condition_names() -> List[str]:
    return list(CONDITIONS.keys())

def build_text(name: str) -> str:
    data = CONDITIONS.get(name)
    if not data:
        return "항목을 찾을 수 없습니다."
    parts = []
    parts.append("📌 " + data["title"][0])
    if data.get("quick"):
        parts.append("• 핵심 요약:\n  - " + "\n  - ".join(data["quick"]))
    if data.get("home"):
        parts.append("• 집에서 할 일:\n  - " + "\n  - ".join(data["home"]))
    if data.get("caution"):
        parts.append("• 주의/금기:\n  - " + "\n  - ".join(data["caution"]))
    if data.get("when_clinic"):
        parts.append("• 언제 외래/소아과 가기:\n  - " + "\n  - ".join(data["when_clinic"]))
    if data.get("when_er"):
        parts.append("• 언제 응급실 가기(🚨):\n  - " + "\n  - ".join(data["when_er"]))
    if data.get("myths"):
        parts.append("• 오해 바로잡기:\n  - " + "\n  - ".join(data["myths"]))
    parts.append(DISCLAIMER)
    parts.append(KST_NOTE)
    return "\n\n".join(parts)

def antipyretic_summary(weight_kg: Optional[float]) -> str:
    apap = ""
    ibu = ""
    if weight_kg and weight_kg > 0:
        apap_min = round(weight_kg * 10)
        apap_max = round(weight_kg * 15)
        ibu_mg = round(weight_kg * 10)
        apap = f"- 아세트아미노펜(APAP): {apap_min}~{apap_max} mg/회 (4~6시간 간격)"
        ibu = f"- 이부프로펜(IBU): 약 {ibu_mg} mg/회 (6~8시간 간격) ※ 생후 6개월 미만은 지양"
    else:
        apap = "- 아세트아미노펜(APAP): 10~15 mg/kg/회 (4~6시간 간격)"
        ibu = "- 이부프로펜(IBU): 10 mg/kg/회 (6~8시간 간격) ※ 생후 6개월 미만은 지양"
    guard = ("- 24시간 총량/성분중복을 반드시 확인하세요.\n"
             "- 다음 복용 가능 시각: APAP ≥4h, IBU ≥6h (앱 .ics 내보내기 활용).")
    return "• 해열제 요약:\n" + "\n".join([apap, ibu, guard])

def build_share_text(name: str, weight_kg: Optional[float]=None) -> str:
    text = build_text(name)
    ap = antipyretic_summary(weight_kg)
    return text + "\n\n" + ap
