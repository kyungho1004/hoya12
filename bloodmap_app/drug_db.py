
# ---------- Fallback Korean aliases (display only; DB alias ìš°ì„ ) ----------
ALIAS_FALLBACK = {
    # Chemo
    "Cytarabine": "ì‹œíƒ€ë¼ë¹ˆ(Ara-C)",
    "Daunorubicin": "ë‹¤ìš°ë…¸ë£¨ë¹„ì‹ ",
    "Idarubicin": "ì´ë‹¤ë£¨ë¹„ì‹ ",
    "ATRA": "íŠ¸ë ˆí‹°ë…¸ì¸",
    "Arsenic Trioxide": "ì‚°í™”ë¹„ì†Œ",
    "MTX": "ë©”í† íŠ¸ë ‰ì„¸ì´íŠ¸",
    "6-MP": "6-ë¨¸ìº…í† í“¨ë¦°",
    "Cyclophosphamide": "ì‚¬ì´í´ë¡œí¬ìŠ¤íŒŒë§ˆì´ë“œ",
    "Prednisone": "í”„ë ˆë“œë‹ˆì†",
    "Vincristine": "ë¹ˆí¬ë¦¬ìŠ¤í‹´",
    "Vinblastine": "ë¹ˆë¸”ë¼ìŠ¤í‹´",
    "Etoposide": "ì—í† í¬ì‚¬ì´ë“œ",
    "Doxorubicin": "ë…ì†Œë£¨ë¹„ì‹ ",
    "Bleomycin": "ë¸”ë ˆì˜¤ë§ˆì´ì‹ ",
    "Dacarbazine": "ë‹¤ì¹´ë°”ì§„",
    "Chlorambucil": "í´ë¡œëŒë¶€ì‹¤",
    "Bendamustine": "ë²¤ë‹¤ë¬´ìŠ¤í‹´",
    "Ibrutinib": "ì´ë¸Œë£¨í‹°ë‹™",
    "Ifosfamide": "ì´í¬ìŠ¤íŒŒë¯¸ë“œ",
    "Gemcitabine": "ì ¬ì‹œíƒ€ë¹ˆ",
    "Docetaxel": "ë„ì„¸íƒì…€",
    "Paclitaxel": "íŒŒí´ë¦¬íƒì…€",
    "Topotecan": "í† í¬í…Œì¹¸",
    "Trabectedin": "íŠ¸ë¼ë²¡í…Œë”˜",
    "Dactinomycin": "ë‹¥í‹°ë…¸ë§ˆì´ì‹ ",
    "Carboplatin": "ì¹´ë³´í”Œë¼í‹´",
    "Cisplatin": "ì‹œìŠ¤í”Œë¼í‹´",
    "Pemetrexed": "í˜ë©”íŠ¸ë ‰ì‹œë“œ",
    "Oxaliplatin": "ì˜¥ì‚´ë¦¬í”Œë¼í‹´",
    "Irinotecan": "ì´ë¦¬ë…¸í…Œì¹¸",
    "Capecitabine": "ì¹´í˜ì‹œíƒ€ë¹ˆ",
    "5-FU": "5-í”Œë£¨ì˜¤ë¡œìš°ë¼ì‹¤",
    "Nab-Paclitaxel": "ë‚˜ë…¸ì…ì íŒŒí´ë¦¬íƒì…€",
    # Targeted / IO
    "Rituximab": "ë¦¬íˆ­ì‹œë§™",
    "Obinutuzumab": "ì˜¤ë¹„ëˆ„íˆ¬ì£¼ë§™",
    "Polatuzumab Vedotin": "í´ë¼íˆ¬ì£¼ë§™ ë² ë„í‹´",
    "Brentuximab Vedotin": "ë¸Œë Œíˆ­ì‹œë§™ ë² ë„í‹´",
    "Nivolumab": "ë‹ˆë³¼ë£¨ë§™",
    "Pembrolizumab": "í¨ë¸Œë¡¤ë¦¬ì£¼ë§™",
    "Atezolizumab": "ì•„í…Œì¡¸ë¦¬ì£¼ë§™",
    "Durvalumab": "ë”ë°œë£¨ë§™",
    "Imatinib": "ì´ë§ˆí‹°ë‹™",
    "Sunitinib": "ìˆ˜ë‹ˆí‹°ë‹™",
    "Regorafenib": "ë ˆê³ ë¼í˜ë‹™",
    "Ripretinib": "ë¦¬í”„ë ˆí‹°ë‹™",
    "Osimertinib": "ì˜¤ì‹œë¨¸í‹°ë‹™",
    "Alectinib": "ì•Œë ‰í‹°ë‹™",
    "Crizotinib": "í¬ë¦¬ì¡°í‹°ë‹™",
    "Lorlatinib": "ë¡œë¥¼ë¼í‹°ë‹™",
    "Larotrectinib": "ë¼ë¡œíŠ¸ë ‰í‹°ë‹™",
    "Entrectinib": "ì—”íŠ¸ë ‰í‹°ë‹™",
    "Capmatinib": "ìº¡ë§ˆí‹°ë‹™",
    "Sotorasib": "ì†Œí† ë¼ì‹­",
    "Trastuzumab": "íŠ¸ë¼ìŠ¤íˆ¬ì£¼ë§™",
    "Pertuzumab": "í¼íˆ¬ì£¼ë§™",
    "T-DM1": "íŠ¸ë¼ìŠ¤íˆ¬ì£¼ë§™ ì— íƒ„ì‹ ",
    "Trastuzumab deruxtecan": "íŠ¸ë¼ìŠ¤íˆ¬ì£¼ë§™ ë°ë£©ìŠ¤í…Œì¹¸",
    "Lapatinib": "ë¼íŒŒí‹°ë‹™",
    "Tucatinib": "íˆ¬ì¹´í‹°ë‹™",
    "Everolimus": "ì—ë² ë¡œë¦¬ë¬´ìŠ¤",
    "Octreotide": "ì˜¥íŠ¸ë ˆì˜¤íƒ€ì´ë“œ",
    "Vandetanib": "ë°˜ë°íƒ€ë‹™",
    "Cabozantinib": "ì¹´ë³´ì”í‹°ë‹™",
    "Selpercatinib": "ì…€í¼ì¹´í‹°ë‹™",
    "Pralsetinib": "í”„ë„ì„¸í‹°ë‹™",
    # Antibiotics
    "Piperacillin/Tazobactam": "í”¼í˜ë¼ì‹¤ë¦°/íƒ€ì¡°ë°•íƒ",
    "Cefepime": "ì„¸í˜í•Œ",
    "Meropenem": "ë©”ë¡œí˜ë„´",
    "Imipenem/Cilastatin": "ì´ë¯¸í˜ë„´/ì‹¤ë¼ìŠ¤íƒ€í‹´",
    "Aztreonam": "ì•„ì¦ˆíŠ¸ë ˆì˜¤ë‚¨",
    "Amikacin": "ì•„ë¯¸ì¹´ì‹ ",
    "Vancomycin": "ë°˜ì½”ë§ˆì´ì‹ ",
    "Linezolid": "ë¦¬ë„¤ì¡¸ë¦¬ë“œ",
    "Daptomycin": "ë‹µí† ë§ˆì´ì‹ ",
    "Ceftazidime": "ì„¸í”„íƒ€ì§€ë”¤",
    "Levofloxacin": "ë ˆë³´í”Œë¡ì‚¬ì‹ ",
    "TMP-SMX": "íŠ¸ë¦¬ë©”í† í”„ë¦¼/ì„¤íŒŒë©”í†¡ì‚¬ì¡¸",
    "Metronidazole": "ë©”íŠ¸ë¡œë‹ˆë‹¤ì¡¸",
    "Amoxicillin/Clavulanate": "ì•„ëª©ì‹œì‹¤ë¦°/í´ë¼ë¶ˆë€ì‚°",
}

def display_label(key: str, db=None) -> str:
    ref = None
    try:
        ref = db if isinstance(db, dict) else DRUG_DB
    except Exception:
        ref = None
    alias = None
    if ref and key in ref and isinstance(ref[key], dict):
        alias = ref[key].get("alias")
    if not alias:
        alias = ALIAS_FALLBACK.get(key)
    if alias and alias != key:
        return f"{key} ({alias})"
    return str(key)

def picklist(keys, db=None):
    ref = db if isinstance(db, dict) else DRUG_DB if 'DRUG_DB' in globals() else {}
    return [display_label(k, ref) for k in (keys or [])]

def key_from_label(label: str, db=None) -> str:
    if not label:
        return ""
    pos = label.find(" (")
    if pos > 0:
        return label[:pos]
    ref = db if isinstance(db, dict) else DRUG_DB if 'DRUG_DB' in globals() else {}
    if label in ref:
        return label
    for k, v in (ref or {}).items():
        if isinstance(v, dict) and v.get("alias") == label:
            return k
    return label

# -*- coding: utf-8 -*-
from typing import Dict, Any

DRUG_DB: Dict[str, Dict[str, Any]] = {}

def _upsert(db, key, alias, moa, ae):
    db.setdefault(key, {})
    db[key].update({"alias": alias, "moa": moa, "ae": ae})
    for alt in {key, key.lower(), alias, alias.lower()}:
        db.setdefault(alt, {"alias": alias, "moa": moa, "ae": ae})

def ensure_onco_drug_db(db: Dict[str, Dict[str, Any]]):
    pass


def picklist(keys):
    return [display_label(k) for k in keys]

def key_from_label(label: str) -> str:
    # Expect "Key (Alias...)" â†’ return "Key"
    if not label:
        return ""
    pos = label.find(" (")
    return label[:pos] if pos > 0 else label

    # --- Antibiotics (FN/oncology common) ---
    _upsert(db, "Piperacillin/Tazobactam", "í”¼í˜ë¼ì‹¤ë¦°/íƒ€ì¡°ë°•íƒ(íƒ€ì¡°ì‹ , Tazocin)",
            "ê´‘ë²”ìœ„ Î²â€‘lactam + Î²â€‘lactamase ì–µì œì œ",
            "ì•Œë ˆë¥´ê¸°/ë°œì§„, ìœ„ì¥ê´€ ì¦ìƒ, C. difficile ì—°ê´€ ì„¤ì‚¬ ê°€ëŠ¥, ë‚˜íŠ¸ë¥¨ ë¶€í•˜, ì‹ ê¸°ëŠ¥ì— ë”°ë¥¸ ìš©ëŸ‰ ì¡°ì ˆ")
    _upsert(db, "Cefepime", "ì„¸í˜í•Œ(4ì„¸ëŒ€)",
            "4ì„¸ëŒ€ ì„¸íŒ”ë¡œìŠ¤í¬ë¦°(ë…¹ë†ê·  í¬í•¨)",
            "ì•Œë ˆë¥´ê¸°, ìœ„ì¥ê´€ ì¦ìƒ, C. difficile, ì‹ ë¶€ì „ ì‹œ **ì‹ ê²½ë…ì„±(í˜¼ë™/ê²½ë ¨)** ìœ„í—˜")
    _upsert(db, "Meropenem", "ë©”ë¡œí˜ë„´(ì¹´ë°”í˜ë„´)",
            "ê´‘ë²”ìœ„ ì¹´ë°”í˜ë„´",
            "ì•Œë ˆë¥´ê¸°, ìœ„ì¥ê´€ ì¦ìƒ, ê²½ë ¨ ë“œë¬¾(íŠ¹íˆ ì‹ ë¶€ì „/ì¤‘ì¶”ì§ˆí™˜)")
    _upsert(db, "Vancomycin", "ë°˜ì½”ë§ˆì´ì‹ ",
            "G(+) ëŒ€ìƒ ê¸€ë¦¬ì½”í©íƒ€ì´ë“œ",
            "ì‹ ë…ì„±, **Red man syndrome**(ê¸‰ì† ì£¼ì… ì‹œ), í˜ˆì¤‘ë†ë„ ëª¨ë‹ˆí„° í•„ìš”, ì²­ë ¥ë…ì„± ë“œë¬¾")
    _upsert(db, "Ceftazidime", "ì„¸í”„íƒ€ì§€ë”¤(3ì„¸ëŒ€)",
            "3ì„¸ëŒ€ ì„¸íŒ”ë¡œìŠ¤í¬ë¦°(ë…¹ë†ê· )",
            "ì•Œë ˆë¥´ê¸°, ìœ„ì¥ê´€ ì¦ìƒ, ë“œë¬¾ê²Œ ì‹ ê²½ë…ì„±")
    _upsert(db, "Levofloxacin", "ë ˆë³´í”Œë¡ì‚¬ì‹ (í€´ë†€ë¡ )",
            "DNA gyrase ì–µì œ",
            "í˜ì¤„ì—¼/íŒŒì—´, QT ì—°ì¥, ê´‘ê³¼ë¯¼, í˜ˆë‹¹ ë³€ë™; 18ì„¸ ë¯¸ë§Œ ì‚¬ìš© ì£¼ì˜")
    _upsert(db, "TMP-SMX", "íŠ¸ë¦¬ë©”í† í”„ë¦¼/ì„¤íŒŒë©”í†¡ì‚¬ì¡¸(ì½”íŠ¸ë¦¼)",
            "ì—½ì‚° ëŒ€ì‚¬ ì–µì œ ì¡°í•©",
            "ê³¨ìˆ˜ì–µì œ, ê³ ì¹¼ë¥¨í˜ˆì¦, ë°œì§„(SJS/TEN ë“œë¬¾), ì‹ ê¸°ëŠ¥ ì˜í–¥; ìƒí˜¸ì‘ìš© ì£¼ì˜")

    # --- Targeted / Immunotherapy additions ---
    _upsert(db, "Polatuzumab Vedotin", "í´ë¼íˆ¬ì£¼ë§™ ë² ë„í‹´(CD79b ADC)", "CD79b í‘œì  í•­ì²´â€‘ì•½ë¬¼ ì ‘í•©ì²´", "ë§ì´ˆì‹ ê²½ë³‘ì¦, ê³¨ìˆ˜ì–µì œ, ì£¼ì…ë°˜ì‘")
    _upsert(db, "Obinutuzumab", "ì˜¤ë¹„ëˆ„íˆ¬ì£¼ë§™(CD20)", "Type II CD20 ë‹¨ì¼í´ë¡ í•­ì²´", "ì£¼ì…ë°˜ì‘, ê°ì—¼, HBV ì¬í™œì„±í™”")
    _upsert(db, "Pembrolizumab", "í¨ë¸Œë¡¤ë¦¬ì£¼ë§™(PDâ€‘1)", "ë©´ì—­ê´€ë¬¸ì–µì œì œ(PDâ€‘1)", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘(í”¼ë¶€, ê°‘ìƒì„ , í, ê°„, ëŒ€ì¥)")
    _upsert(db, "Nivolumab", "ë‹ˆë³¼ë£¨ë§™(PDâ€‘1)", "ë©´ì—­ê´€ë¬¸ì–µì œì œ(PDâ€‘1)", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘(í”¼ë¶€, ê°‘ìƒì„ , í, ê°„, ëŒ€ì¥)")
    _upsert(db, "Atezolizumab", "ì•„í…Œì¡¸ë¦¬ì£¼ë§™(PDâ€‘L1)", "ë©´ì—­ê´€ë¬¸ì–µì œì œ(PDâ€‘L1)", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘")
    _upsert(db, "Durvalumab", "ë”ë°œë£¨ë§™(PDâ€‘L1)", "ë©´ì—­ê´€ë¬¸ì–µì œì œ(PDâ€‘L1)", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘")
    _upsert(db, "Pertuzumab", "í¼íˆ¬ì£¼ë§™(HER2)", "HER2 dimerization ì–µì œ", "ì„¤ì‚¬, ë°œì§„, ì‹¬ê¸°ëŠ¥ì €í•˜(ë“œë¬¾)")
    _upsert(db, "T-DM1", "íŠ¸ë¼ìŠ¤íˆ¬ì£¼ë§™â€‘ì— íƒ„ì‹ (Tâ€‘DM1)", "HER2 ADC", "í˜ˆì†ŒíŒê°ì†Œ, ê°„íš¨ì†Œ ìƒìŠ¹, í”¼ë¡œ")
    _upsert(db, "Regorafenib", "ë ˆê³ ë¼í˜ë‹™", "ë©€í‹° TKI(GIST/ëŒ€ì¥ì•” ë“±)", "ìˆ˜ì¡±ì¦í›„êµ°, ê³ í˜ˆì••, ê°„ë…ì„±")
    _upsert(db, "Ripretinib", "ë¦¬í”„ë ˆí‹°ë‹™", "KIT/PDGFRA ìŠ¤ìœ„ì¹˜í¬ì¼“ ì–µì œ(GIST)", "íƒˆëª¨, í”¼ë¡œ, ê³ í˜ˆì••")

    _upsert(db, "Cabozantinib", "ì¹´ë³´ì”í‹°ë‹™", "ë©€í‹° TKI(RET/MET/VEGFR)", "ê³ í˜ˆì••, ì„¤ì‚¬, ì†ë°œì¦í›„êµ°")
    _upsert(db, "Vandetanib", "ë°˜ë°íƒ€ë‹™", "RET/EGFR/VEGFR TKI(MTC)", "QT ì—°ì¥, ì„¤ì‚¬, ë°œì§„")
    _upsert(db, "Capmatinib", "ìº¡ë§ˆí‹°ë‹™(MET)", "MET ì–µì œ(NSCLC)", "ë§ì´ˆë¶€ì¢…, ì˜¤ì‹¬, ê´‘ê³¼ë¯¼")
    _upsert(db, "Sotorasib", "ì†Œí† ë¼ì‹­(KRAS G12C)", "KRAS G12C ì–µì œ", "ì„¤ì‚¬, ALT/AST ìƒìŠ¹")

    # --- More antibiotics (FN/pathogen coverage common) ---
    _upsert(db, "Imipenem/Cilastatin", "ì´ë¯¸í˜ë„´/ì‹¤ë¼ìŠ¤íƒ€í‹´(ì¹´ë°”í˜ë„´)", "ê´‘ë²”ìœ„ ì¹´ë°”í˜ë„´", "ê²½ë ¨ ìœ„í—˜(íŠ¹íˆ ì‹ ë¶€ì „/ì¤‘ì¶”ì§ˆí™˜), ìœ„ì¥ê´€ ì¦ìƒ")
    _upsert(db, "Aztreonam", "ì•„ì¦ˆíŠ¸ë ˆì˜¤ë‚¨", "ê·¸ëŒìŒì„± ì„ íƒ Î²â€‘lactam(ë…¹ë†ê·  í¬í•¨)", "ë°œì§„, ìœ„ì¥ê´€ ì¦ìƒ; Î²â€‘lactam ì•Œë ˆë¥´ê¸° ì‹œ ëŒ€ì•ˆ(ì„¸í˜ì—  êµì°¨ë°˜ì‘ ë‚®ìŒ)")
    _upsert(db, "Amikacin", "ì•„ë¯¸ì¹´ì‹ (ì•„ë¯¸ë…¸ê¸€ë¦¬ì½”ì‹œë“œ)", "ë‹¨ë°± í•©ì„± ì–µì œ", "ì‹ ë…ì„±/ì´ë…ì„± ëª¨ë‹ˆí„° í•„ìš”")
    _upsert(db, "Linezolid", "ë¦¬ë„¤ì¡¸ë¦¬ë“œ", "G(+) MRSA/VRE ì˜¥ì‚¬ì¡¸ë¦¬ë””ë…¼", "í˜ˆì†ŒíŒê°ì†Œ, ë§ì´ˆ/ì‹œì‹ ê²½ë³‘ì¦(ì¥ê¸°), ì„¸ë¡œí† ë‹Œì¦í›„êµ° ì£¼ì˜")
    _upsert(db, "Daptomycin", "ë‹¤í”„í† ë§ˆì´ì‹ ", "G(+) ë¦¬í¬í©íƒ€ì´ë“œ", "CPK ìƒìŠ¹/ê·¼ë³‘ì¦, íë ´ ì¹˜ë£Œì—ëŠ” ë¶€ì í•©(ì„œíŒ©í„´íŠ¸ì— ë¹„í™œì„±)")
    _upsert(db, "Metronidazole", "ë©”íŠ¸ë¡œë‹ˆë‹¤ì¡¸", "í˜ê¸°ì„± ì»¤ë²„ë¦¬ì§€", "ê¸ˆì†ë§›, ì•Œì½”ì˜¬ ê¸ˆê¸°(ë””ì„¤í”¼ëŒ ìœ ì‚¬ë°˜ì‘), ë§ì´ˆì‹ ê²½ë³‘ì¦(ì¥ê¸°)")
    _upsert(db, "Amoxicillin/Clavulanate", "ì•„ëª©ì‹œì‹¤ë¦°/í´ë¼ë¶ˆë€ì‚°(ì˜¤êµ¬ë©˜í‹´)", "ê²½êµ¬ ê´‘ë²”ìœ„ Î²â€‘lactam + ì–µì œì œ", "ì„¤ì‚¬/ë°œì§„, ê°„íš¨ì†Œ ìƒìŠ¹ ë“œë¬¾")



    _upsert(db, "Chlorambucil", "í´ë¡œëŒë¶€ì‹¤", "ì•Œí‚¬í™”ì œ(ê²½êµ¬)", "ê³¨ìˆ˜ì–µì œ, ë°œì§„, ê°„íš¨ì†Œ ìƒìŠ¹ ë“œë¬¾")
    _upsert(db, "Lenalidomide", "ë ˆë‚ ë¦¬ë„ë§ˆì´ë“œ", "ë©´ì—­ì¡°ì ˆì œ(IMiD)", "í˜ˆì „ì¦ ìœ„í—˜, ê³¨ìˆ˜ì–µì œ, ë°œì§„; ì„ì‹  ê¸ˆê¸°")

    # --- Solid tumor targeted / immuno expansions ---
    _upsert(db, "Cetuximab", "ì„¸íˆ­ì‹œë§™(EGFR)", "EGFR ë‹¨ì¼í´ë¡ í•­ì²´(ëŒ€ì¥ì•”/ë‘ê²½ë¶€ì•”)", "ì£¼ì…ë°˜ì‘, ì €ë§ˆê·¸ë„¤ìŠ˜í˜ˆì¦, ì—¬ë“œë¦„ì–‘ ë°œì§„, ì„¤ì‚¬")
    _upsert(db, "Panitumumab", "íŒŒë‹ˆíˆ¬ë¬´ë§™(EGFR)", "EGFR ë‹¨ì¼í´ë¡ í•­ì²´(ëŒ€ì¥ì•”)", "ì €ë§ˆê·¸ë„¤ìŠ˜í˜ˆì¦, í”¼ë¶€ë°œì§„, ì„¤ì‚¬")
    _upsert(db, "Ramucirumab", "ë¼ë¬´ì‹œë£¨ë§™(VEGFR2)", "VEGFR2 í•­ì²´(ìœ„ì•”/ê°„ì•” ë“±)", "ê³ í˜ˆì••, ë‹¨ë°±ë‡¨, ì¶œí˜ˆ/í˜ˆì „, ìƒì²˜ì¹˜ìœ  ì§€ì—°")
    _upsert(db, "Lapatinib", "ë¼íŒŒí‹°ë‹™(HER2/EGFR)", "HER2/EGFR TKI(ìœ ë°©ì•”)", "ì„¤ì‚¬, ë°œì§„, ê°„íš¨ì†Œ ìƒìŠ¹, ë“œë¬¼ê²Œ ì‹¬ë…ì„±")
    _upsert(db, "Tucatinib", "íˆ¬ì¹´í‹°ë‹™(HER2)", "HER2 ì„ íƒì  TKI(ìœ ë°©ì•”)", "ì„¤ì‚¬, ê°„íš¨ì†Œ ìƒìŠ¹, í”¼ë¡œ")
    _upsert(db, "Trastuzumab deruxtecan", "íŠ¸ë¼ìŠ¤íˆ¬ì£¼ë§™ ë°ë£©ìŠ¤í…Œì¹¸(T-DXd)", "HER2 ADC", "ê°„ì§ˆì„± íì§ˆí™˜/íë ´ ìœ„í—˜, ì˜¤ì‹¬/êµ¬í† , ê³¨ìˆ˜ì–µì œ")
    _upsert(db, "Olaparib", "ì˜¬ë¼íŒŒë¦½(PARP)", "PARP ì–µì œì œ(ë‚œì†Œ/ìœ ë°© ë“±)", "ë¹ˆí˜ˆ/í˜ˆì†ŒíŒê°ì†Œ, í”¼ë¡œ, êµ¬ì—­")
    _upsert(db, "Niraparib", "ë‹ˆë¼íŒŒë¦½(PARP)", "PARP ì–µì œì œ(ë‚œì†Œ)", "í˜ˆì†ŒíŒê°ì†Œ, ë¹ˆí˜ˆ, ê³ í˜ˆì••, í”¼ë¡œ")
    _upsert(db, "Palbociclib", "íŒ”ë³´ì‹œí´ë¦½(CDK4/6)", "CDK4/6 ì–µì œì œ(ìœ ë°©ì•”)", "í˜¸ì¤‘êµ¬ê°ì†Œì¦, í”¼ë¡œ, êµ¬ë‚´ì—¼")
    _upsert(db, "Ribociclib", "ë¦¬ë³´ì‹œí´ë¦½(CDK4/6)", "CDK4/6 ì–µì œì œ(ìœ ë°©ì•”)", "í˜¸ì¤‘êµ¬ê°ì†Œì¦, QT ì—°ì¥, ê°„íš¨ì†Œ ìƒìŠ¹")
    _upsert(db, "Abemaciclib", "ì•„ë² ë§ˆì‹œí´ë¦½(CDK4/6)", "CDK4/6 ì–µì œì œ(ìœ ë°©ì•”)", "ì„¤ì‚¬, í˜¸ì¤‘êµ¬ê°ì†Œì¦, í”¼ë¡œ")
    _upsert(db, "Lorlatinib", "ë¡œë¥¼ë¼í‹°ë‹™(ALK)", "ALK TKI(NSCLC)", "ì§€ì§ˆ ìƒìŠ¹, ì¸ì§€/ê¸°ë¶„ ë³€í™”, ì²´ì¤‘ì¦ê°€")
    _upsert(db, "Selpercatinib", "ì…€í¼ì¹´í‹°ë‹™(RET)", "RET TKI(NSCLC/MTC)", "ê³ í˜ˆì••, ê°„íš¨ì†Œ ìƒìŠ¹, ë“œë¬¼ê²Œ QT ì—°ì¥")
    _upsert(db, "Pralsetinib", "í”„ë„ì„¸í‹°ë‹™(RET)", "RET TKI(NSCLC)", "ê³ í˜ˆì••, ê°„íš¨ì†Œ ìƒìŠ¹, ë³€ë¹„/ì„¤ì‚¬")
    _upsert(db, "Dabrafenib", "ë‹¤ë¸Œë¼í˜ë‹™(BRAF)", "BRAF V600 ì–µì œ(í‘ìƒ‰ì¢…/íì•”)", "ë°œì—´, í”¼ë¶€ë°œì§„, ê´€ì ˆí†µ")
    _upsert(db, "Trametinib", "íŠ¸ë¼ë©”í‹°ë‹™(MEK)", "MEK ì–µì œ", "ì‹¬ê¸°ëŠ¥ì €í•˜/ì¢Œì‹¬ì‹¤ ê¸°ëŠ¥ ê°ì†Œ, í”¼ë¶€/ì„¤ì‚¬")
    _upsert(db, "Encorafenib", "ì—”ì½”ë¼í˜ë‹™(BRAF)", "BRAF ì–µì œ", "í”¼ë¡œ, ê´€ì ˆí†µ, ë°œì§„")
    _upsert(db, "Binimetinib", "ë¹„ë‹ˆë©”í‹°ë‹™(MEK)", "MEK ì–µì œ", "ë§ë§‰/ì‹œì•¼ ì´ìƒ ë“œë¬¾, ì„¤ì‚¬/ë°œì§„")
    _upsert(db, "Ipilimumab", "ì´í•„ë¦¬ë¬´ë§™(CTLA-4)", "ë©´ì—­ê´€ë¬¸ì–µì œì œ(CTLA-4)", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘(ëŒ€ì¥ì—¼/ê°„ì—¼/í”¼ë¶€/ë‚´ë¶„ë¹„)")

    # --- Additional chemo used in solid tumors ---
    _upsert(db, "Nab-Paclitaxel", "ë‚˜ë¸Œ-íŒŒí´ë¦¬íƒì…€", "ì•Œë¶€ë¯¼ ê²°í•© íŒŒí´ë¦¬íƒì…€", "ë§ì´ˆì‹ ê²½ë³‘ì¦, ê³¨ìˆ˜ì–µì œ, íƒˆëª¨")
    _upsert(db, "Topotecan", "í† í¬í…Œì¹¸", "Topo I ì–µì œ(ë‚œì†Œ/ì†Œì„¸í¬íì•”)", "ê³¨ìˆ˜ì–µì œ, í”¼ë¡œ, ì˜¤ì‹¬")



# ====== PATCH: extend ensure_onco_drug_db with APL + missing therapies ======
try:
    _original_ensure_onco_drug_db = ensure_onco_drug_db
except NameError:
    _original_ensure_onco_drug_db = None

def ensure_onco_drug_db(db):
    # Call original to keep upstream list
    if _original_ensure_onco_drug_db is not None:
        _original_ensure_onco_drug_db(db)
    # APL core

    _upsert(db, "Cytarabine", "ì‹œíƒ€ë¼ë¹ˆ(Araâ€‘C)", "í”¼ë¦¬ë¯¸ë”˜ ìœ ì‚¬ì²´(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ë°œì—´, ì ë§‰ì—¼, ë“œë¬¼ê²Œ ì‹ ê²½ë…ì„±")
    _upsert(db, "Daunorubicin", "ë‹¤ìš°ë…¸ë£¨ë¹„ì‹ ", "Topo II ì–µì œ(ì•ˆíŠ¸ë¼ì‚¬ì´í´ë¦°)", "ì‹¬ê·¼ë…ì„±(ëˆ„ì ), ê³¨ìˆ˜ì–µì œ, ì ë§‰ì—¼")
    _upsert(db, "Idarubicin", "ì´ë‹¤ë£¨ë¹„ì‹ ", "Topo II ì–µì œ(ì•ˆíŠ¸ë¼ì‚¬ì´í´ë¦°)", "ì‹¬ê·¼ë…ì„±, ê³¨ìˆ˜ì–µì œ, ì˜¤ì‹¬/êµ¬í† ")
    _upsert(db, "Tretinoin", "íŠ¸ë ˆí‹°ë…¸ì¸(ATRA)", "RARÎ± ì‘ìš© â€” ë¶„í™” ìœ ë„", "ë¶„í™”ì¦í›„êµ°(DS): ë°œì—´Â·í˜¸í¡ê³¤ë€/íì¹¨ìœ¤Â·ì €ì‚°ì†Œì¦, í‰ë§‰/ì‹¬ë§‰ì‚¼ì¶œ, ê¸‰ê²©í•œ ì²´ì¤‘ì¦ê°€(ë¶€ì¢…)Â·ì €í˜ˆì••Â·ì‹ ì¥ê¸°ëŠ¥ì €í•˜; ëŒ€ê°œ íˆ¬ì—¬ 2â€“21ì¼ ì´ë‚´ ë°œìƒ, ë°±í˜ˆêµ¬ ê¸‰ì¦ ë™ë°˜ ê°€ëŠ¥. ì˜ì‹¬ ì¦‰ì‹œ **ë±ì‚¬ë©”íƒ€ì† 10 mg IV q12h** ì‹œì‘, ì‚°ì†Œ/ìˆ˜ì•¡/ì „í•´ì§ˆ ë³´ì •, ì¤‘ì¦ ì‹œ ATRA/ATO ì¼ì‹œì¤‘ë‹¨ ê³ ë ¤. ê³ ìœ„í—˜(ì´ˆì§„ë‹¨ ì‹œ ê³ ë°±í˜ˆêµ¬ ë“±)ì€ ì˜ˆë°©ì  ìŠ¤í…Œë¡œì´ë“œ ê³ ë ¤), ê°„íš¨ì†Œ ìƒìŠ¹, ë‘í†µ/í”¼ë¶€ê±´ì¡°, ì ë§‰ì—¼")
    _upsert(db, "Arsenic Trioxide", "ì‚°í™”ë¹„ì†Œ(ATO)", "ë¶„í™” ìœ ë„/ì•„í¬í† ì‹œìŠ¤", "ë¶„í™”ì¦í›„êµ°(ATRAì™€ ë™ì¼ ê´€ë¦¬), **QT ì—°ì¥**(ì €K/ì €Mg êµì •Â·ECG ëª¨ë‹ˆí„°ë§, ìœ„í—˜ì•½ë¬¼ ë³‘ìš© ì£¼ì˜), ì „í•´ì§ˆ ì´ìƒ, ê°„íš¨ì†Œ ìƒìŠ¹/í”¼ë¶€ë°œì§„")

    # Missing/expanded

    _upsert(db, "Doxorubicin", "ë…ì†Œë£¨ë¹„ì‹ (Adriamycin)", "Topo II ì–µì œ(ì•ˆíŠ¸ë¼ì‚¬ì´í´ë¦°)", "ì‹¬ê·¼ë…ì„±(ëˆ„ì ), ê³¨ìˆ˜ì–µì œ, ì ë§‰ì—¼, íƒˆëª¨")
    _upsert(db, "Chlorambucil", "í´ë¡œëŒë¶€ì‹¤", "ì•Œí‚¬í™”ì œ", "ê³¨ìˆ˜ì–µì œ, ì˜¤ì‹¬/êµ¬í† ")
    _upsert(db, "Obinutuzumab", "ì˜¤ë¹„ëˆ„íˆ¬ì£¼ë§™(CD20)", "CD20 ë‹¨ì¼í´ë¡ í•­ì²´", "ì£¼ì…ë°˜ì‘, ê°ì—¼ìœ„í—˜, HBV ì¬í™œì„±í™”")
    _upsert(db, "Polatuzumab Vedotin", "í´ë¼íˆ¬ì£¼ë§™ ë² ë„í‹´(CD79b ADC)", "CD79b í‘œì  í•­ì²´â€‘ì•½ë¬¼ ì ‘í•©ì²´", "ë§ì´ˆì‹ ê²½ë³‘ì¦, ê³¨ìˆ˜ì–µì œ, ì£¼ì…ë°˜ì‘")
    _upsert(db, "Pembrolizumab", "í¨ë¸Œë¡¤ë¦¬ì£¼ë§™(PD-1)", "PD-1 ë©´ì—­ê´€ë¬¸ì–µì œì œ", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘(í”¼ë¶€/ëŒ€ì¥ì—¼/ê°„ì—¼/ë‚´ë¶„ë¹„)")
    _upsert(db, "Nivolumab", "ë‹ˆë³¼ë£¨ë§™(PD-1)", "PD-1 ë©´ì—­ê´€ë¬¸ì–µì œì œ", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘")
    _upsert(db, "Osimertinib", "ì˜¤ì‹œë¨¸í‹°ë‹™(EGFR)", "EGFR TKI(Ex19del/L858R/T790M)", "ì„¤ì‚¬, ë°œì§„, ë“œë¬¼ê²Œ ILD")
    _upsert(db, "Alectinib", "ì•Œë ‰í‹°ë‹™(ALK)", "ALK TKI", "ê·¼ìœ¡í†µ, ë³€ë¹„, ê°„íš¨ì†Œ ìƒìŠ¹")
    _upsert(db, "Crizotinib", "í¬ë¦¬ì¡°í‹°ë‹™(ALK/ROS1)", "ALK/ROS1 TKI", "ì‹œì•¼ íë¦¼, ìœ„ì¥ê´€ ì¦ìƒ")
    _upsert(db, "Lorlatinib", "ë¡œë¥¼ë¼í‹°ë‹™(ALK)", "ALK TKI", "ì§€ì§ˆ ìƒìŠ¹, ì¸ì§€/ê¸°ë¶„ ë³€í™”")
    _upsert(db, "Entrectinib", "ì—”íŠ¸ë ‰í‹°ë‹™(ROS1/NTRK)", "ROS1/NTRK TKI", "ì²´ì¤‘ ì¦ê°€, ì–´ì§€ëŸ¬ì›€")
    _upsert(db, "Larotrectinib", "ë¼ë¡œíŠ¸ë ‰í‹°ë‹™(NTRK)", "NTRK TKI", "í”¼ë¡œ, ì–´ì§€ëŸ¬ì›€")
    _upsert(db, "Capmatinib", "ìº¡ë§ˆí‹°ë‹™(MET)", "MET TKI", "ë§ì´ˆë¶€ì¢…, ê°„íš¨ì†Œ ìƒìŠ¹")
    _upsert(db, "Sotorasib", "ì†Œí† ë¼ì‹­(KRAS G12C)", "KRAS G12C ì–µì œì œ", "ì„¤ì‚¬, ê°„íš¨ì†Œ ìƒìŠ¹")
    _upsert(db, "Ramucirumab", "ë¼ë¬´ì‹œë£¨ë§™(VEGFR2)", "VEGFR2 ë‹¨ì¼í´ë¡ í•­ì²´", "ê³ í˜ˆì••, ì¶œí˜ˆìœ„í—˜")
    _upsert(db, "Regorafenib", "ë ˆê³ ë¼í˜ë‹™", "ë©€í‹°í‚¤ë‚˜ì•„ì œ ì–µì œì œ", "ì†ë°œì¦í›„êµ°, í”¼ë¡œ, ê³ í˜ˆì••")
    _upsert(db, "Ripretinib", "ë¦¬í”„ë ˆí‹°ë‹™", "KIT/PDGFRA ì–µì œ(GIST)", "íƒˆëª¨, í”¼ë¡œ, ì†ë°œì¦í›„êµ°")
    _upsert(db, "Vandetanib", "ë°˜ë°íƒ€ë‹™(RET)", "RET/VEGFR/EGFR TKI", "QT ì—°ì¥, ì„¤ì‚¬, ë°œì§„")
    _upsert(db, "Cabozantinib", "ì¹´ë³´ì”í‹°ë‹™", "MET/VEGFR/RET TKI", "ì„¤ì‚¬, í”¼ë¡œ, ì†ë°œì¦í›„êµ°")
    _upsert(db, "Selpercatinib", "ì…€í¼ì¹´í‹°ë‹™(RET)", "RET TKI(NSCLC/MTC)", "ê³ í˜ˆì••, ê°„íš¨ì†Œ ìƒìŠ¹, QT ì—°ì¥ ë“œë¬¾")
    _upsert(db, "Pralsetinib", "í”„ë„ì„¸í‹°ë‹›(RET)", "RET TKI(NSCLC/MTC)", "ê³ í˜ˆì••, ê°„íš¨ì†Œ ìƒìŠ¹, ë³€ë¹„/ì„¤ì‚¬")
    _upsert(db, "Pertuzumab", "í¼íˆ¬ì£¼ë§™(HER2)", "HER2 dimer ì–µì œ", "ì„¤ì‚¬, LVEF ê°ì†Œ")
    _upsert(db, "T-DM1", "ì•„ë„â€‘íŠ¸ë¼ìŠ¤íˆ¬ì£¼ë§™ ì— íƒ„ì‹ (Tâ€‘DM1)", "HER2 ADC", "í˜ˆì†ŒíŒ ê°ì†Œ, ê°„ë…ì„±")
    _upsert(db, "Trastuzumab deruxtecan", "íŠ¸ë¼ìŠ¤íˆ¬ì£¼ë§™ ë°ë£©ìŠ¤í…Œì¹¸(Tâ€‘DXd)", "HER2 ADC", "ê°„ì§ˆì„± íì§ˆí™˜(ILD) ìœ„í—˜, ì˜¤ì‹¬")
    _upsert(db, "Tucatinib", "íˆ¬ì¹´í‹°ë‹™(HER2)", "HER2 TKI", "ì„¤ì‚¬, ê°„íš¨ì†Œ ìƒìŠ¹")
    _upsert(db, "Lapatinib", "ë¼íŒŒí‹°ë‹™(HER2)", "HER2 TKI", "ì„¤ì‚¬, ë°œì§„")


    # Mirror with quoted keys for onco_map entries that accidentally include quotes
    def __mirror_with_quotes(key):
        if key in db:
            entry = db.get(key, {})
            _upsert(db, f"'{key}'", entry.get('alias', key), entry.get('moa', ''), entry.get('ae', ''))
            _upsert(db, f'"{key}"', entry.get('alias', key), entry.get('moa', ''), entry.get('ae', ''))
    for __k in [
        "Atezolizumab","Cetuximab","Durvalumab","Lenvatinib","Nab-Paclitaxel",
        "Niraparib","Olaparib","Panitumumab","Sorafenib","Topotecan",
        "Doxorubicin","Osimertinib","Tretinoin","Cytarabine","Arsenic Trioxide"
    ]:
        __mirror_with_quotes(__k)


    # Common synonyms used in ONCO map
    _upsert(db, "ATRA", "íŠ¸ë ˆí‹°ë…¸ì¸(ATRA)", "RARÎ± ì‘ìš© â€” ë¶„í™” ìœ ë„", "ë¶„í™”ì¦í›„êµ°(DS): ë°œì—´Â·í˜¸í¡ê³¤ë€/íì¹¨ìœ¤Â·ì €ì‚°ì†Œì¦, í‰ë§‰/ì‹¬ë§‰ì‚¼ì¶œ, ê¸‰ê²©í•œ ì²´ì¤‘ì¦ê°€(ë¶€ì¢…)Â·ì €í˜ˆì••Â·ì‹ ì¥ê¸°ëŠ¥ì €í•˜; ëŒ€ê°œ íˆ¬ì—¬ 2â€“21ì¼ ì´ë‚´ ë°œìƒ, ë°±í˜ˆêµ¬ ê¸‰ì¦ ë™ë°˜ ê°€ëŠ¥. ì˜ì‹¬ ì¦‰ì‹œ **ë±ì‚¬ë©”íƒ€ì† 10 mg IV q12h** ì‹œì‘, ì‚°ì†Œ/ìˆ˜ì•¡/ì „í•´ì§ˆ ë³´ì •, ì¤‘ì¦ ì‹œ ATRA/ATO ì¼ì‹œì¤‘ë‹¨ ê³ ë ¤. ê³ ìœ„í—˜(ì´ˆì§„ë‹¨ ì‹œ ê³ ë°±í˜ˆêµ¬ ë“±)ì€ ì˜ˆë°©ì  ìŠ¤í…Œë¡œì´ë“œ ê³ ë ¤), ê°„íš¨ì†Œ ìƒìŠ¹, ë‘í†µ/í”¼ë¶€ê±´ì¡°, ì ë§‰ì—¼")
    _upsert(db, "MTX", "ë©”í† íŠ¸ë ‰ì„¸ì´íŠ¸(MTX)", "DHFR ì–µì œ(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ì ë§‰ì—¼, ê°„ë…ì„±, ì‹ ì¥ë…ì„±(ê³ ìš©ëŸ‰)")
    _upsert(db, "6-MP", "6-ë¨¸ìº…í† í“¨ë¦°(6-MP)", "í“¨ë¦° ìœ ì‚¬ì²´(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ê°„ë…ì„±(íŠ¹íˆ ë³‘ìš©ì•½ë¬¼ ìƒí˜¸ì‘ìš©)")

# ====== END PATCH ======


# === FINAL ensure_onco_drug_db (patched) ===
try:
    _original_ensure_onco_drug_db
except NameError:
    _original_ensure_onco_drug_db = None

def ensure_onco_drug_db(db):
    if _original_ensure_onco_drug_db is not None:
        _original_ensure_onco_drug_db(db)
    # APL core
    _upsert(db, "Cytarabine", "ì‹œíƒ€ë¼ë¹ˆ(Araâ€‘C)", "í”¼ë¦¬ë¯¸ë”˜ ìœ ì‚¬ì²´(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ë°œì—´, ì ë§‰ì—¼, ë“œë¬¼ê²Œ ì‹ ê²½ë…ì„±")
    _upsert(db, "Daunorubicin", "ë‹¤ìš°ë…¸ë£¨ë¹„ì‹ ", "Topo II ì–µì œ(ì•ˆíŠ¸ë¼ì‚¬ì´í´ë¦°)", "ì‹¬ê·¼ë…ì„±(ëˆ„ì ), ê³¨ìˆ˜ì–µì œ, ì ë§‰ì—¼")
    _upsert(db, "Idarubicin", "ì´ë‹¤ë£¨ë¹„ì‹ ", "Topo II ì–µì œ(ì•ˆíŠ¸ë¼ì‚¬ì´í´ë¦°)", "ì‹¬ê·¼ë…ì„±, ê³¨ìˆ˜ì–µì œ, ì˜¤ì‹¬/êµ¬í† ")
    _upsert(db, "Tretinoin", "íŠ¸ë ˆí‹°ë…¸ì¸(ATRA)", "RARÎ± ì‘ìš© â€” ë¶„í™” ìœ ë„", "ë¶„í™”ì¦í›„êµ°(DS): ë°œì—´Â·í˜¸í¡ê³¤ë€/íì¹¨ìœ¤Â·ì €ì‚°ì†Œì¦, í‰ë§‰/ì‹¬ë§‰ì‚¼ì¶œ, ê¸‰ê²©í•œ ì²´ì¤‘ì¦ê°€(ë¶€ì¢…)Â·ì €í˜ˆì••Â·ì‹ ì¥ê¸°ëŠ¥ì €í•˜; ëŒ€ê°œ íˆ¬ì—¬ 2â€“21ì¼ ì´ë‚´ ë°œìƒ, ë°±í˜ˆêµ¬ ê¸‰ì¦ ë™ë°˜ ê°€ëŠ¥. ì˜ì‹¬ ì¦‰ì‹œ **ë±ì‚¬ë©”íƒ€ì† 10 mg IV q12h** ì‹œì‘, ì‚°ì†Œ/ìˆ˜ì•¡/ì „í•´ì§ˆ ë³´ì •, ì¤‘ì¦ ì‹œ ATRA/ATO ì¼ì‹œì¤‘ë‹¨ ê³ ë ¤. ê³ ìœ„í—˜(ì´ˆì§„ë‹¨ ì‹œ ê³ ë°±í˜ˆêµ¬ ë“±)ì€ ì˜ˆë°©ì  ìŠ¤í…Œë¡œì´ë“œ ê³ ë ¤), ê°„íš¨ì†Œ ìƒìŠ¹, ë‘í†µ/í”¼ë¶€ê±´ì¡°, ì ë§‰ì—¼")
    _upsert(db, "Arsenic Trioxide", "ì‚°í™”ë¹„ì†Œ(ATO)", "ë¶„í™” ìœ ë„/ì•„í¬í† ì‹œìŠ¤", "ë¶„í™”ì¦í›„êµ°(ATRAì™€ ë™ì¼ ê´€ë¦¬), **QT ì—°ì¥**(ì €K/ì €Mg êµì •Â·ECG ëª¨ë‹ˆí„°ë§, ìœ„í—˜ì•½ë¬¼ ë³‘ìš© ì£¼ì˜), ì „í•´ì§ˆ ì´ìƒ, ê°„íš¨ì†Œ ìƒìŠ¹/í”¼ë¶€ë°œì§„")

    # Solid/GI/HCC & EGFR/HER2 & PARP í™•ì¥
    _upsert(db, "Atezolizumab", "ì•„í…Œì¡¸ë¦¬ì£¼ë§™(PD-L1)", "PD-L1 ë©´ì—­ê´€ë¬¸ì–µì œì œ", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘")
    _upsert(db, "Cetuximab", "ì„¸íˆ­ì‹œë§™(EGFR)", "EGFR ë‹¨ì¼í´ë¡ í•­ì²´", "ì—¬ë“œë¦„ì–‘ ë°œì§„, ì €ë§ˆê·¸ë„¤ìŠ˜í˜ˆì¦")
    _upsert(db, "Durvalumab", "ë”ë°œë£¨ë§™(PD-L1)", "PD-L1 ë©´ì—­ê´€ë¬¸ì–µì œì œ", "ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘")
    _upsert(db, "Lenvatinib", "ë Œë°”í‹°ë‹™", "VEGFR/FGFR TKI", "ê³ í˜ˆì••, ë‹¨ë°±ë‡¨")
    _upsert(db, "Niraparib", "ë‹ˆë¼íŒŒë¦½(PARP)", "PARP ì–µì œì œ", "í˜ˆì†ŒíŒ ê°ì†Œ, í”¼ë¡œ")
    _upsert(db, "Olaparib", "ì˜¬ë¼íŒŒë¦½(PARP)", "PARP ì–µì œì œ", "ë¹ˆí˜ˆ, í”¼ë¡œ, ì˜¤ì‹¬")
    _upsert(db, "Panitumumab", "íŒŒë‹ˆíˆ¬ë¬´ë§™(EGFR)", "EGFR ë‹¨ì¼í´ë¡ í•­ì²´", "í”¼ë¶€ë°œì§„, ì €ë§ˆê·¸ë„¤ìŠ˜í˜ˆì¦")
    _upsert(db, "Sorafenib", "ì†Œë¼í˜ë‹™", "VEGFR/RAF TKI", "ì†ë°œì¦í›„êµ°, ê³ í˜ˆì••")
    _upsert(db, "Topotecan", "í† í¬í…Œì¹¸", "Topo I ì–µì œ(ë‚œì†Œ/ì†Œì„¸í¬íì•”)", "ê³¨ìˆ˜ì–µì œ, í”¼ë¡œ, ì˜¤ì‹¬")
    _upsert(db, "Nab-Paclitaxel", "ë‚˜ë¸Œ-íŒŒí´ë¦¬íƒì…€", "ì•Œë¶€ë¯¼ ê²°í•© íŒŒí´ë¦¬íƒì…€", "ë§ì´ˆì‹ ê²½ë³‘ì¦, ê³¨ìˆ˜ì–µì œ, íƒˆëª¨")

    # ì•½ì–´/ë™ì˜ì–´
    _upsert(db, "ATRA", "íŠ¸ë ˆí‹°ë…¸ì¸(ATRA)", "RARÎ± ì‘ìš© â€” ë¶„í™” ìœ ë„", "ë¶„í™”ì¦í›„êµ°(DS): ë°œì—´Â·í˜¸í¡ê³¤ë€/íì¹¨ìœ¤Â·ì €ì‚°ì†Œì¦, í‰ë§‰/ì‹¬ë§‰ì‚¼ì¶œ, ê¸‰ê²©í•œ ì²´ì¤‘ì¦ê°€(ë¶€ì¢…)Â·ì €í˜ˆì••Â·ì‹ ì¥ê¸°ëŠ¥ì €í•˜; ëŒ€ê°œ íˆ¬ì—¬ 2â€“21ì¼ ì´ë‚´ ë°œìƒ, ë°±í˜ˆêµ¬ ê¸‰ì¦ ë™ë°˜ ê°€ëŠ¥. ì˜ì‹¬ ì¦‰ì‹œ **ë±ì‚¬ë©”íƒ€ì† 10 mg IV q12h** ì‹œì‘, ì‚°ì†Œ/ìˆ˜ì•¡/ì „í•´ì§ˆ ë³´ì •, ì¤‘ì¦ ì‹œ ATRA/ATO ì¼ì‹œì¤‘ë‹¨ ê³ ë ¤. ê³ ìœ„í—˜(ì´ˆì§„ë‹¨ ì‹œ ê³ ë°±í˜ˆêµ¬ ë“±)ì€ ì˜ˆë°©ì  ìŠ¤í…Œë¡œì´ë“œ ê³ ë ¤), ê°„íš¨ì†Œ ìƒìŠ¹, ë‘í†µ/í”¼ë¶€ê±´ì¡°, ì ë§‰ì—¼")
    _upsert(db, "MTX", "ë©”í† íŠ¸ë ‰ì„¸ì´íŠ¸(MTX)", "DHFR ì–µì œ(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ì ë§‰ì—¼, ê°„ë…ì„±, ì‹ ì¥ë…ì„±(ê³ ìš©ëŸ‰)")
    _upsert(db, "6-MP", "6-ë¨¸ìº…í† í“¨ë¦°(6-MP)", "í“¨ë¦° ìœ ì‚¬ì²´(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ê°„ë…ì„±(íŠ¹íˆ ë³‘ìš©ì•½ë¬¼ ìƒí˜¸ì‘ìš©)")



# === AUTO-FILL: ensure all ONCO_MAP-referenced names exist ===
try:
    __prev_ensure = ensure_onco_drug_db
except NameError:
    __prev_ensure = None

def ensure_onco_drug_db(db):
    if __prev_ensure is not None:
        __prev_ensure(db)
    _upsert(db, "5-FU", "5-FU", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Alectinib", "Alectinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Ara-C", "Ara-C", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Bendamustine", "Bendamustine", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Bevacizumab", "Bevacizumab", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Bleomycin", "Bleomycin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Brentuximab Vedotin", "Brentuximab Vedotin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Cabozantinib", "Cabozantinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Capecitabine", "Capecitabine", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Capmatinib", "Capmatinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Carboplatin", "Carboplatin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Chlorambucil", "Chlorambucil", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Cisplatin", "Cisplatin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Crizotinib", "Crizotinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Cyclophosphamide", "Cyclophosphamide", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Dacarbazine", "Dacarbazine", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Dactinomycin", "Dactinomycin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Docetaxel", "Docetaxel", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Doxorubicin", "Doxorubicin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Entrectinib", "Entrectinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Etoposide", "Etoposide", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Everolimus", "Everolimus", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Gemcitabine", "Gemcitabine", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Ibrutinib", "Ibrutinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Ifosfamide", "Ifosfamide", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Imatinib", "Imatinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Irinotecan", "Irinotecan", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Lapatinib", "Lapatinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Larotrectinib", "Larotrectinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Lorlatinib", "Lorlatinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Nivolumab", "Nivolumab", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Obinutuzumab", "Obinutuzumab", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Octreotide", "Octreotide", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Osimertinib", "Osimertinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Oxaliplatin", "Oxaliplatin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Paclitaxel", "Paclitaxel", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Pazopanib", "Pazopanib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Pembrolizumab", "Pembrolizumab", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Pemetrexed", "Pemetrexed", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Pertuzumab", "Pertuzumab", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Polatuzumab Vedotin", "Polatuzumab Vedotin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Pralsetinib", "Pralsetinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Prednisone", "Prednisone", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Ramucirumab", "Ramucirumab", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Regorafenib", "Regorafenib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Ripretinib", "Ripretinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Rituximab", "Rituximab", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Selpercatinib", "Selpercatinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Sotorasib", "Sotorasib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Sunitinib", "Sunitinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "T-DM1", "T-DM1", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Trabectedin", "Trabectedin", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Trastuzumab", "Trastuzumab", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Trastuzumab deruxtecan", "Trastuzumab deruxtecan", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Tucatinib", "Tucatinib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Vandetanib", "Vandetanib", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Vinblastine", "Vinblastine", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")
    _upsert(db, "Vincristine", "Vincristine", "í•­ì•”/í‘œì ì¹˜ë£Œ(ìë™ë“±ë¡)", "ë¶€ì‘ìš© ì •ë³´ í•„ìš”")

# === SYNONYMS for maintenance/alias ===
try:
    __prev2 = ensure_onco_drug_db
except NameError:
    __prev2 = None

def ensure_onco_drug_db(db):
    if __prev2 is not None:
        __prev2(db)
    _upsert(db, "Ara-C", "ì‹œíƒ€ë¼ë¹ˆ(Ara-C)", "í”¼ë¦¬ë¯¸ë”˜ ìœ ì‚¬ì²´(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ë°œì—´, ì ë§‰ì—¼, ë“œë¬¼ê²Œ ì‹ ê²½ë…ì„±")
    _upsert(db, "Methotrexate", "ë©”í† íŠ¸ë ‰ì„¸ì´íŠ¸(MTX)", "DHFR ì–µì œ(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ì ë§‰ì—¼, ê°„ë…ì„±, ì‹ ì¥ë…ì„±(ê³ ìš©ëŸ‰)")
    _upsert(db, "Mercaptopurine", "6-ë¨¸ìº…í† í“¨ë¦°(6-MP)", "í“¨ë¦° ìœ ì‚¬ì²´(í•­ëŒ€ì‚¬ì œ)", "ê³¨ìˆ˜ì–µì œ, ê°„ë…ì„±(ìƒí˜¸ì‘ìš© ì£¼ì˜)")

# --- UI Helper: display_label ---
def display_label(key: str, db: dict = None) -> str:
    """ì•½ë¬¼ í‚¤ë¥¼ ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ ë¼ë²¨(í•œê¸€ ë³‘ê¸° alias)ë¡œ ë³€í™˜.
    - dbê°€ ì£¼ì–´ì§€ë©´ ê·¸ dictë¥¼, ì•„ë‹ˆë©´ ëª¨ë“ˆ ì „ì—­ DRUG_DB ì‚¬ìš©
    - í‚¤ëŠ” ë”°ì˜´í‘œ/ê³µë°±ì„ ì œê±°í•˜ì—¬ ì¡°íšŒ ì‹œë„
    """
    try:
        ref = db if isinstance(db, dict) else DRUG_DB
    except NameError:
        ref = db or {}
    k = key if isinstance(key, str) else str(key)
    norm = k.strip().strip("'\"")
    entry = ref.get(norm) or ref.get(k)
    if isinstance(entry, dict):
        return entry.get("alias") or norm
    return norm


# ====== PATCH v2025-10-19: Fill missing AEs + Korean labels (emoji) ======
try:
    __prev_ensure = ensure_onco_drug_db  # chain previous layers
except Exception:
    __prev_ensure = None

def ensure_onco_drug_db(db):
    # keep everything previously registered
    if __prev_ensure is not None:
        __prev_ensure(db)

    def _alias(k: str) -> str:
        # Prefer existing alias â†’ else fallback map
        rec = (db or {}).get(k) or {}
        a = rec.get("alias")
        if a: 
            return a
        try:
            # ALIAS_FALLBACK is defined earlier in this module
            return ALIAS_FALLBACK.get(k, k)
        except Exception:
            return k

    def add(k, alias=None, moa="", ae="", tags=None):
        lab = alias or _alias(k)
        _upsert(db, k, lab, moa or "í•­ì•”/í‘œì ì¹˜ë£Œ", ae or "(ë³´ê°• í•„ìš”)")
        if tags:
            rec = db.setdefault(k, {})
            prev = set(rec.get("tags", []))
            rec["tags"] = sorted(prev | set(tags))

    # --- canonical minimal profiles (focus: ì¤‘ìš”ë¶€ì‘ìš© ì´ëª¨ì§€) ---
    PROFILES = {
        "5-FU": {
            "moa": "í”¼ë¦¬ë¯¸ë”˜ ìœ ì‚¬ì²´(í•­ëŒ€ì‚¬ì œ)",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ¤¢ ì˜¤ì‹¬/êµ¬í†  Â· ğŸ’© ì„¤ì‚¬ Â· ğŸ’Š êµ¬ë‚´ì—¼ Â· ğŸ–ï¸ ì†ë°œì¦í›„êµ°",
            "tags": ["myelosuppression","mucositis","hand_foot"]
        },
        "Ara-C": {
            "moa": "í”¼ë¦¬ë¯¸ë”˜ ìœ ì‚¬ì²´(í•­ëŒ€ì‚¬ì œ)",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸŒ¡ï¸ ë°œì—´ Â· ğŸ’Š ì ë§‰ì—¼ Â· ğŸ§  ê³ ìš©ëŸ‰ ì‹œ ì‹ ê²½ë…ì„±",
            "tags": ["myelosuppression","neurotoxicity"]
        },
        "Capecitabine": {
            "moa": "5â€‘FU ì „êµ¬ì•½ë¬¼(í•­ëŒ€ì‚¬ì œ)",
            "ae": "ğŸ–ï¸ ì†ë°œì¦í›„êµ° Â· ğŸ’© ì„¤ì‚¬ Â· ğŸ’Š êµ¬ë‚´ì—¼ Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ",
            "tags": ["hand_foot","mucositis","myelosuppression"]
        },
        "Cisplatin": {
            "moa": "ë°±ê¸ˆì œ(ì•Œí‚¬í™” ìœ ì‚¬)",
            "ae": "ğŸ§â€â™‚ï¸ ì´ë…ì„± Â· ğŸš½ ì‹ ë…ì„± Â· ğŸ¤¢ ì‹¬í•œ êµ¬í†  Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ",
            "tags": ["nephrotoxicity","ototoxicity","emetogenic","myelosuppression"]
        },
        "Carboplatin": {
            "moa": "ë°±ê¸ˆì œ",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ(í˜ˆì†ŒíŒâ†“) Â· ğŸ¤¢ ì˜¤ì‹¬/êµ¬í†  Â· âš ï¸ ì•Œë ˆë¥´ê¸°ë°˜ì‘",
            "tags": ["myelosuppression","hypersensitivity","emetogenic"]
        },
        "Oxaliplatin": {
            "moa": "ë°±ê¸ˆì œ",
            "ae": "ğŸ§  ë§ì´ˆì‹ ê²½ë³‘ì¦(ì €ì˜¨ ìœ ë°œ) Â· ğŸ¤¢ ì˜¤ì‹¬/êµ¬í†  Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ",
            "tags": ["neuropathy","myelosuppression","emetogenic"]
        },
        "Docetaxel": {
            "moa": "íƒì‚°(Taxane)",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ’§ ë¶€ì¢…/ì²´ì•¡ì €ë¥˜ Â· ğŸ¤§ ê³¼ë¯¼ë°˜ì‘",
            "tags": ["myelosuppression","fluid_retention","hypersensitivity"]
        },
        "Paclitaxel": {
            "moa": "íƒì‚°(Taxane)",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ§  ë§ì´ˆì‹ ê²½ë³‘ì¦ Â· ğŸ¤§ ê³¼ë¯¼ë°˜ì‘",
            "tags": ["myelosuppression","neuropathy","hypersensitivity"]
        },
        "Doxorubicin": {
            "moa": "ì•ˆíŠ¸ë¼ì‚¬ì´í´ë¦°(Topo II ì–µì œ)",
            "ae": "â¤ï¸ ì‹¬ê·¼ë…ì„±(ëˆ„ì  ìš©ëŸ‰) Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ’Š ì ë§‰ì—¼ Â· ğŸ”´ ì£¼ì‚¬í˜ˆê´€ì—¼/ê´´ì‚¬(ëˆ„ì¶œ)",
            "tags": ["cardiotoxicity","myelosuppression","mucositis","vesicant"]
        },
        "Etoposide": {
            "moa": "Topo II ì–µì œ",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ¤¢ ì˜¤ì‹¬/êµ¬í†  Â· ğŸ¦  ê°ì—¼ìœ„í—˜ ì¦ê°€",
            "tags": ["myelosuppression"]
        },
        "Cyclophosphamide": {
            "moa": "ì•Œí‚¬í™”ì œ",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ©¸ í˜ˆë‡¨/ì¶œí˜ˆì„± ë°©ê´‘ì—¼(ê³ ìš©ëŸ‰) Â· ğŸ¤¢ ì˜¤ì‹¬/êµ¬í† ",
            "tags": ["myelosuppression","hemorrhagic_cystitis"]
        },
        "Ifosfamide": {
            "moa": "ì•Œí‚¬í™”ì œ",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ§  ì‹ ê²½ë…ì„±/ì„¬ë§ Â· ğŸ©¸ ì¶œí˜ˆì„± ë°©ê´‘ì—¼(MESNA ë³‘ìš©)",
            "tags": ["myelosuppression","neurotoxicity","hemorrhagic_cystitis"]
        },
        "Gemcitabine": {
            "moa": "í”¼ë¦¬ë¯¸ë”˜ ìœ ì‚¬ì²´",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ˜®â€ğŸ’¨ í˜¸í¡ê³¤ë€/ê°„ì§ˆì„± íì§ˆí™˜ ë“œë¬¾ Â· ë°œì—´/í”¼ë¡œ",
            "tags": ["myelosuppression","ild_pneumonitis"]
        },
        "Irinotecan": {
            "moa": "Topo I ì–µì œ",
            "ae": "ğŸ’© ì„¤ì‚¬(ê¸‰ì„±Â·ì§€ì—°) Â· ğŸ¤¢ ì˜¤ì‹¬/êµ¬í†  Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ",
            "tags": ["diarrhea","myelosuppression"]
        },
        "Pemetrexed": {
            "moa": "í•­ëŒ€ì‚¬ì œ(ì—½ì‚° ê²½ë¡œ)",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ’Š êµ¬ë‚´ì—¼ Â· ğŸ¤¢ ì˜¤ì‹¬/êµ¬í†  (ì—½ì‚°/ë¹„12 ë³´ì¶© í•„ìš”)",
            "tags": ["myelosuppression","mucositis"]
        },
        "Bevacizumab": {
            "moa": "VEGF ì–µì œ",
            "ae": "ğŸ©¸ ì¶œí˜ˆ/ìƒì²˜ì¹˜ìœ  ì§€ì—° Â· ğŸ§  í˜ˆì „Â·í—ˆí˜ˆ Â· ğŸ’¥ ì²œê³µ(ë“œë¬¾) Â· ğŸ’‰ ë‹¨ë°±ë‡¨/ê³ í˜ˆì••",
            "tags": ["bleeding","hypertension","proteinuria","gi_perforation"]
        },
        "Ramucirumab": {
            "moa": "VEGFRâ€‘2 ì–µì œ",
            "ae": "ğŸ©¸ ì¶œí˜ˆÂ·ê³ í˜ˆì•• Â· ğŸ’‰ ë‹¨ë°±ë‡¨ Â· ìƒì²˜ì¹˜ìœ  ì§€ì—°",
            "tags": ["bleeding","hypertension","proteinuria"]
        },
        "Regorafenib": {
            "moa": "ë©€í‹° TKI",
            "ae": "ğŸ–ï¸ ì†ë°œì¦í›„êµ° Â· ğŸ©¸ ê³ í˜ˆì•• Â· ğŸ§ª ê°„ë…ì„±",
            "tags": ["hand_foot","hypertension","hepatotoxicity"]
        },
        "Sunitinib": {
            "moa": "ë©€í‹° TKI",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ§ª ê°„íš¨ì†Œ ìƒìŠ¹ Â· ğŸ¥µ í”¼ë¡œ/ì‹ìš•ì €í•˜ Â· ğŸ¦· ì ë§‰ì—¼",
            "tags": ["myelosuppression","hepatotoxicity","mucositis"]
        },
        "Imatinib": {
            "moa": "TKI (BCRâ€‘ABL, KIT)",
            "ae": "ğŸ’§ ë¶€ì¢… Â· ğŸ¥µ í”¼ë¡œ Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ì†ì“°ë¦¼/êµ¬ì—­",
            "tags": ["myelosuppression","edema"]
        },
        "Ibrutinib": {
            "moa": "BTK ì–µì œ",
            "ae": "ğŸ©¸ ì¶œí˜ˆ ìœ„í—˜ Â· ğŸ’“ ì‹¬ë°©ì„¸ë™ Â· ì„¤ì‚¬/í”¼ë¡œ",
            "tags": ["bleeding","arrhythmia"]
        },
        "Bendamustine": {
            "moa": "ì•Œí‚¬í™”ì œ",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ¤¢ ì˜¤ì‹¬/êµ¬í†  Â· ë°œì—´",
            "tags": ["myelosuppression"]
        },
        "Chlorambucil": {
            "moa": "ì•Œí‚¬í™”ì œ",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ë°œì§„/ì˜¤ì‹¬",
            "tags": ["myelosuppression"]
        },
        "Bleomycin": {
            "moa": "DNA ì†ìƒ",
            "ae": "ğŸ« íë…ì„±/ì„¬ìœ í™” Â· ğŸ¤§ ë°œì—´/ì˜¤í•œ Â· í”¼ë¶€ë³€í™”(ì„ ì¡°/ê²½ê²°)",
            "tags": ["pulmonary_toxicity"]
        },
        "Dacarbazine": {
            "moa": "ì•Œí‚¬í™”ì œ",
            "ae": "ğŸ¤¢ ê³ ìœ„í—˜ êµ¬í†  Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ê´‘ê³¼ë¯¼",
            "tags": ["emetogenic","myelosuppression"]
        },
        "Dactinomycin": {
            "moa": "DNA í•©ì„± ì–µì œ",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ’Š ì ë§‰ì—¼ Â· ğŸ”´ ì£¼ì‚¬í˜ˆê´€ì—¼/ê´´ì‚¬(ëˆ„ì¶œ)",
            "tags": ["myelosuppression","mucositis","vesicant"]
        },
        "Trabectedin": {
            "moa": "DNA groove ê²°í•©",
            "ae": "ğŸ§ª ê°„ë…ì„± Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ê·¼ìœ¡í†µ/í”¼ë¡œ",
            "tags": ["hepatotoxicity","myelosuppression"]
        },
        "Vincristine": {
            "moa": "Vinca alkaloid",
            "ae": "ğŸ§  ë§ì´ˆì‹ ê²½ë³‘ì¦ Â· ë³€ë¹„/ì¥íìƒ‰ Â· (ìƒëŒ€ì ) ê³¨ìˆ˜ì–µì œ ì ìŒ",
            "tags": ["neuropathy"]
        },
        "Vinblastine": {
            "moa": "Vinca alkaloid",
            "ae": "ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ğŸ§  ë§ì´ˆì‹ ê²½ë³‘ì¦ Â· íƒˆëª¨",
            "tags": ["myelosuppression","neuropathy"]
        },
        "Nivolumab": {
            "moa": "PDâ€‘1 ì–µì œ(ë©´ì—­í•­ì•”ì œ)",
            "ae": "ğŸ›¡ï¸ ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘(í”¼ë¶€/ê°‘ìƒì„ /í/ê°„/ì¥) Â· í”¼ë¡œ",
            "tags": ["immunotherapy"]
        },
        "Pembrolizumab": {
            "moa": "PDâ€‘1 ì–µì œ",
            "ae": "ğŸ›¡ï¸ ë©´ì—­ê´€ë ¨ ì´ìƒë°˜ì‘ Â· ë°œì§„/í”¼ë¡œ",
            "tags": ["immunotherapy"]
        },
        "Obinutuzumab": {
            "moa": "Antiâ€‘CD20",
            "ae": "ğŸ’‰ ì£¼ì…ë°˜ì‘ Â· ğŸ¦  ê°ì—¼ìœ„í—˜ Â· ğŸ©¸ í˜¸ì¤‘êµ¬ê°ì†Œ",
            "tags": ["infusion_reaction","myelosuppression"]
        },
        "Rituximab": {
            "moa": "Antiâ€‘CD20",
            "ae": "ğŸ’‰ ì£¼ì…ë°˜ì‘ Â· ğŸ’¤ í”¼ë¡œ Â· ë“œë¬¼ê²Œ PML",
            "tags": ["infusion_reaction"]
        },
        "Polatuzumab Vedotin": {
            "moa": "ADC(antiâ€‘CD79b)",
            "ae": "ğŸ©¸ í˜¸ì¤‘êµ¬ê°ì†Œ Â· ğŸ§  ë§ì´ˆì‹ ê²½ë³‘ì¦ Â· ğŸ’‰ ì£¼ì…ë°˜ì‘",
            "tags": ["myelosuppression","neuropathy","infusion_reaction"]
        },
        "Brentuximab Vedotin": {
            "moa": "ADC(antiâ€‘CD30)",
            "ae": "ğŸ§  ë§ì´ˆì‹ ê²½ë³‘ì¦ Â· ğŸ©¸ í˜¸ì¤‘êµ¬ê°ì†Œ Â· ğŸ’‰ ì£¼ì…ë°˜ì‘",
            "tags": ["neuropathy","myelosuppression","infusion_reaction"]
        },
        "Trastuzumab": {
            "moa": "HER2 ì–µì œ",
            "ae": "â¤ï¸ ì‹¬ê¸°ëŠ¥ì €í•˜(ì¢Œì‹¬ì‹¤) Â· ğŸ’‰ ì£¼ì…ë°˜ì‘",
            "tags": ["cardiotoxicity","infusion_reaction"]
        },
        "Pertuzumab": {
            "moa": "HER2 dimerization ì–µì œ",
            "ae": "ğŸ’© ì„¤ì‚¬ Â· ğŸ’‰ ì£¼ì…ë°˜ì‘ Â· â¤ï¸ ì‹¬ê¸°ëŠ¥ì €í•˜(ë“œë¬¾)",
            "tags": ["diarrhea","cardiotoxicity","infusion_reaction"]
        },
        "T-DM1": {
            "moa": "HER2 ADC",
            "ae": "ğŸ©¸ í˜ˆì†ŒíŒê°ì†Œ Â· ğŸ§ª ê°„íš¨ì†Œ ìƒìŠ¹ Â· í”¼ë¡œ/ì˜¤ì‹¬",
            "tags": ["myelosuppression","hepatotoxicity"]
        },
        "Trastuzumab deruxtecan": {
            "moa": "HER2 ADC",
            "ae": "ğŸ« ê°„ì§ˆì„±íì§ˆí™˜/íë ´ Â· ğŸ©¸ ê³¨ìˆ˜ì–µì œ Â· ì˜¤ì‹¬",
            "tags": ["ild_pneumonitis","myelosuppression"]
        },
        "Lapatinib": {
            "moa": "HER2/EGFR TKI",
            "ae": "ğŸ’© ì„¤ì‚¬ Â· ë°œì§„ Â· ë“œë¬¼ê²Œ QT ì—°ì¥",
            "tags": ["diarrhea","qt_prolong"]
        },
        "Tucatinib": {
            "moa": "HER2 TKI",
            "ae": "ğŸ’© ì„¤ì‚¬ Â· ğŸ§ª ê°„íš¨ì†Œ ìƒìŠ¹",
            "tags": ["diarrhea","hepatotoxicity"]
        },
        "Osimertinib": {
            "moa": "EGFR TKI",
            "ae": "ğŸ« ILD/íë ´(ë“œë¬¾) Â· âš¡ QT ì—°ì¥ Â· ë°œì§„/ì„¤ì‚¬",
            "tags": ["ild_pneumonitis","qt_prolong"]
        },
        "Alectinib": {
            "moa": "ALK TKI",
            "ae": "ğŸ§ª ê°„íš¨ì†Œ ìƒìŠ¹ Â· ê·¼ìœ¡í†µ/CPKâ†‘ Â· ë³€ë¹„ Â· ë“œë¬¼ê²Œ ILD",
            "tags": ["hepatotoxicity","ild_pneumonitis"]
        },
        "Crizotinib": {
            "moa": "ALK/MET TKI",
            "ae": "ğŸ‘€ ì‹œì•¼ ë³€í™” Â· ğŸ’© ì„¤ì‚¬/ë³€ë¹„ Â· ë¶€ì¢… Â· ê°„íš¨ì†Œ ìƒìŠ¹",
            "tags": ["hepatotoxicity"]
        },
        "Lorlatinib": {
            "moa": "ALK TKI",
            "ae": "ğŸ§  ì¸ì§€/ê¸°ë¶„ ë³€í™” Â· ê³ ì§€í˜ˆì¦ Â· ë§ì´ˆë¶€ì¢…",
            "tags": ["cns_effects"]
        },
        "Larotrectinib": {
            "moa": "TRK TKI",
            "ae": "ğŸ§  ì–´ì§€ëŸ¼/í”¼ë¡œ Â· ê°„íš¨ì†Œ ìƒìŠ¹",
            "tags": ["hepatotoxicity"]
        },
        "Entrectinib": {
            "moa": "TRK/ROS1/ALK TKI",
            "ae": "ğŸ§  ì–´ì§€ëŸ¼/ì²´ì¤‘ì¦ê°€ Â· ğŸ’§ ë¶€ì¢… Â· ê°„íš¨ì†Œ ìƒìŠ¹",
            "tags": ["hepatotoxicity"]
        },
        "Selpercatinib": {
            "moa": "RET TKI",
            "ae": "ğŸ©¸ ê³ í˜ˆì•• Â· ê°„íš¨ì†Œ ìƒìŠ¹ Â· ğŸ’© ì„¤ì‚¬ Â· QT ì—°ì¥ ê°€ëŠ¥",
            "tags": ["hypertension","hepatotoxicity","qt_prolong"]
        },
        "Pralsetinib": {
            "moa": "RET TKI",
            "ae": "ğŸ©¸ ê³ í˜ˆì•• Â· ê°„íš¨ì†Œ ìƒìŠ¹ Â· ë³€ë¹„/ì„¤ì‚¬",
            "tags": ["hypertension","hepatotoxicity"]
        },
        "Vandetanib": {
            "moa": "RET/EGFR/VEGFR TKI",
            "ae": "âš¡ QT ì—°ì¥ Â· ğŸ’© ì„¤ì‚¬ Â· ë°œì§„",
            "tags": ["qt_prolong"]
        },
        "Cabozantinib": {
            "moa": "RET/MET/VEGFR TKI",
            "ae": "ğŸ©¸ ê³ í˜ˆì•• Â· ğŸ–ï¸ ì†ë°œì¦í›„êµ° Â· ì„¤ì‚¬ Â· í”¼ë¡œ",
            "tags": ["hypertension","hand_foot"]
        },
        "Pazopanib": {
            "moa": "ë©€í‹° TKI",
            "ae": "ğŸ§ª ê°„ë…ì„± Â· ğŸ©¸ ê³ í˜ˆì•• Â· ëª¨ë°œ íƒˆìƒ‰",
            "tags": ["hepatotoxicity","hypertension"]
        },
        "Ripretinib": {
            "moa": "KIT/PDGFRA ì–µì œ(GIST)",
            "ae": "ğŸ§‘â€ğŸ¦² íƒˆëª¨ Â· ğŸ©¸ ê³ í˜ˆì•• Â· í”¼ë¡œ/í†µì¦",
            "tags": ["hypertension"]
        },
        "Octreotide": {
            "moa": "Somatostatin ìœ ì‚¬ì²´",
            "ae": "ğŸ’© ì§€ë°©ë³€/ì„¤ì‚¬ Â· ë³µë¶€ë¶ˆí¸ê° Â· ë‹´ì„",
            "tags": ["diarrhea"]
        },
        "Everolimus": {
            "moa": "mTOR ì–µì œ",
            "ae": "ğŸ« ILD/íë ´ Â· ğŸ©¸ ê³ í˜ˆë‹¹/ê³ ì§€í˜ˆì¦ Â· êµ¬ë‚´ì—¼",
            "tags": ["ild_pneumonitis","mucositis"]
        },
        "Ramucirumab": {
            "moa": "VEGFRâ€‘2 ì–µì œ",
            "ae": "ğŸ©¸ ì¶œí˜ˆ Â· ê³ í˜ˆì•• Â· ë‹¨ë°±ë‡¨",
            "tags": ["bleeding","hypertension","proteinuria"]
        },
        "Prednisone": {
            "moa": "ì½”ë¥´í‹°ì½”ìŠ¤í…Œë¡œì´ë“œ",
            "ae": "ğŸ˜  ê¸°ë¶„ë³€í™” Â· ğŸ½ï¸ ì‹ìš•â†‘/ì²´ì¤‘â†‘ Â· í˜ˆë‹¹â†‘ Â· ë¶ˆë©´",
            "tags": ["steroid"]
        },
        "Sotorasib": {
            "moa": "KRAS G12C ì–µì œ",
            "ae": "ğŸ’© ì„¤ì‚¬ Â· ğŸ§ª ALT/AST ìƒìŠ¹ Â· í”¼ë¡œ",
            "tags": ["hepatotoxicity","diarrhea"]
        },
    }

    for k, v in PROFILES.items():
        add(k, alias=None, moa=v.get("moa",""), ae=v.get("ae",""), tags=v.get("tags"))


# --- tiny patch: add Capmatinib profile ---
try:
    __prev_ensure_capmat = ensure_onco_drug_db
except Exception:
    __prev_ensure_capmat = None

def ensure_onco_drug_db(db):
    if __prev_ensure_capmat is not None:
        __prev_ensure_capmat(db)
    _upsert(db, "Capmatinib", ALIAS_FALLBACK.get("Capmatinib","ìº¡ë§ˆí‹°ë‹™(MET)"), "MET TKI", "ë§ì´ˆë¶€ì¢… Â· ì˜¤ì‹¬/êµ¬í†  Â· ê´‘ê³¼ë¯¼ Â· ê°„íš¨ì†Œ ìƒìŠ¹")


# === SAFE FINAL WRAPPER (break mutual recursion) ===
def _call_prev_safely(db):
    g = globals()
    # snapshot and temporarily disable recursive bridges
    saved_prev = g.get('__prev_ensure', None)
    saved_prev2 = g.get('__prev2', None)
    g['__prev_ensure'] = None
    g['__prev2'] = None
    try:
        # prefer the later wrapper (__prev2), else earlier
        prev = saved_prev2 or saved_prev
        if callable(prev):
            try:
                prev(db)
            except Exception:
                # don't hard-fail if legacy layer has minor issues
                pass
    finally:
        g['__prev_ensure'] = saved_prev
        g['__prev2'] = saved_prev2

try:
    _BASE_ENSURE = ensure_onco_drug_db
except Exception:
    _BASE_ENSURE = None

def ensure_onco_drug_db(db):
    # prevent re-entry
    g = globals()
    if g.get('_ENSURE_GUARD', False):
        return
    g['_ENSURE_GUARD'] = True
    try:
        # call previous layers once without bouncing into each other
        _call_prev_safely(db)
        # nothing else here: earlier layers already populated oncology/antibiotics/maps
        # This wrapper's sole job is to stop infinite recursion that was crashing the server.
        return
    finally:
        g['_ENSURE_GUARD'] = False
