# -*- coding: utf-8 -*-
import streamlit as st

# ============================
# Basic Setup
# ============================
st.set_page_config(page_title="í”¼ìˆ˜ì¹˜ Â· ë³´í˜¸ì ê°€ì´ë“œ", layout="wide")

# Floating feedback button (ìš°ì¸¡ í•˜ë‹¨)
st.markdown("""
<style>
.fb-float {position: fixed; right: 16px; bottom: 16px; z-index: 99999;}
.fb-btn {background:#2563eb;color:#fff;padding:12px 14px;border-radius:999px;
         box-shadow:0 8px 24px rgba(37,99,235,.35);font-weight:600;display:inline-flex;
         align-items:center;gap:8px;text-decoration:none}
.fb-btn:hover{background:#1e40af}
</style>
<div class="fb-float">
  <a class="fb-btn" href="mailto:lee729812@gmail.com?subject=%5B%ED%94%BC%EC%88%98%EC%B9%98%20%EC%95%B1%5D%20%EC%9D%98%EA%B2%AC%20%EB%B0%8F%20%EC%98%A4%EB%A5%98%20%EC%A0%9C%EB%B3%B4"
     target="_blank">âœ‰ï¸ ì˜ê²¬ ë³´ë‚´ê¸°</a>
</div>
""", unsafe_allow_html=True)

# ============================
# Utilities & Data
# ============================
def wkey(s: str) -> str:
    return f"app_{s}"

def get_weights():
    if "weights" not in st.session_state:
        st.session_state["weights"] = {}
    return st.session_state["weights"]

def set_weights(newW):
    st.session_state["weights"] = dict(newW)

# í”„ë¦¬ì…‹(í•„ìš”ì— ë§ê²Œ í™•ì¥ ê°€ëŠ¥)
PRESETS = {
    "ê¸°ë³¸(Default)": {},
    "ë³´ìˆ˜ì (ì•ˆì „ ìš°ì„ )": {
        "w_temp_ge_38_5": 1.2, "w_dyspnea": 1.2, "w_confusion": 1.2, "w_oliguria": 1.2, "w_persistent_vomit": 1.2
    },
}

# ============================
# Caregiver Guide helpers
# ============================
def _peds_homecare_details_soft(
    *, score, stool, fever, cough, eye,
    oliguria, ear_pain, rash, hives, abd_pain, migraine, hfmd
):
    st.markdown("### ë³´í˜¸ì ìƒì„¸ ê°€ì´ë“œ")

    def _box(title, items):
        st.markdown(f"**{title}**")
        for it in items:
            st.write("- " + it)

    # ê³µí†µ ì•ˆë‚´
    _box("ğŸŸ¡ ì˜¤ëŠ˜ ì§‘ì—ì„œ ì‚´í´ë³´ë©´ ì¢‹ì•„ìš”", [
        "ë¯¸ì˜¨ìˆ˜ë‚˜ ORSë¥¼ ì†ŒëŸ‰ì”© ìì£¼ ë“œì…”ë³´ì„¸ìš”.",
        "ì‹¤ë‚´ëŠ” ê°€ë³ê³  í¸ì•ˆí•œ ë³µì¥, í™˜ê¸°ì™€ ê°€ìŠµì„ ì ë‹¹íˆ í•´ ì£¼ì„¸ìš”.",
        "í•´ì—´ì œëŠ” ê°„ê²©ì„ ì§€í‚¤ë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤: APAP 4ì‹œê°„ ì´ìƒ, IBU 6ì‹œê°„ ì´ìƒ.",
    ])

    # ì¥ì—¼/ì„¤ì‚¬ ì˜ì‹¬
    if score.get("ì¥ì—¼ ì˜ì‹¬", 0) > 0 or stool in ["3~4íšŒ", "5~6íšŒ", "7íšŒ ì´ìƒ"]:
        _box("ğŸ’§ ì¥ì—¼/ì„¤ì‚¬ ì˜ì‹¬ â€” ì§‘ì—ì„œ", [
            "ORS ë˜ëŠ” ë¯¸ì˜¨ìˆ˜/ë§‘ì€ êµ­ë¬¼ì„ ì¡°ê¸ˆì”© ìì£¼ ë“œì…”ë³´ì„¸ìš”. êµ¬í† ê°€ ìˆìœ¼ë©´ 10â€“15ë¶„ ì‰¬ê³  ë‹¤ì‹œ ì‹œë„í•´ìš”.",
            "ê¸°ë¦„ì§€ê±°ë‚˜ ìê·¹ì ì¸ ìŒì‹, ìœ ì œí’ˆì€ ì ì‹œ ì‰¬ì–´ê°€ìš”.",
            "ì£½Â·ë°”ë‚˜ë‚˜Â·ì‚¬ê³¼í“¨ë ˆÂ·í† ìŠ¤íŠ¸ì²˜ëŸ¼ ë¶€ë“œëŸ¬ìš´ ìŒì‹ë¶€í„° ì²œì²œíˆ ì‹œì‘í•´ìš”.",
            "ë°°ë³€Â·ì†Œë³€Â·ì²´ì˜¨ ë³€í™”ë¥¼ ê°„ë‹¨íˆ ê¸°ë¡í•´ ë‘ì‹œë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤.",
        ])

    # ê²°ë§‰ì—¼ ì˜ì‹¬
    if score.get("ê²°ë§‰ì—¼ ì˜ì‹¬", 0) > 0 or eye in ["ë…¸ë‘-ë†ì„±", "ì–‘ìª½"]:
        _box("ğŸ‘ï¸ ê²°ë§‰ì—¼ ì˜ì‹¬ â€” ì§‘ì—ì„œ", [
            "ì† ì”»ê¸°ë¥¼ ìì£¼ í•´ ì£¼ì„¸ìš”. ìˆ˜ê±´Â·ë² ê°œëŠ” í•¨ê»˜ ì‚¬ìš©í•˜ì§€ ì•Šì•„ìš”.",
            "ìƒë¦¬ì‹ì—¼ìˆ˜ë¡œ ë¶€ë“œëŸ½ê²Œ ì”»ì–´ë‚´ê³ , ë¶„ë¹„ë¬¼ì€ ì•ˆìª½â†’ë°”ê¹¥ìª½ ë°©í–¥ìœ¼ë¡œ ë‹¦ì•„ì¤˜ìš”.",
            "ë¶ˆí¸ê°ì´ ìˆìœ¼ë©´ ì§§ê²Œ ëƒ‰ì°œì§ˆì„ ì‹œë„í•´ ë³¼ ìˆ˜ ìˆì–´ìš”(ì–¼ìŒì€ ì§ì ‘ ëŒ€ì§€ ì•Šê¸°).",
            "ì•ˆì•½Â·í•­ìƒì œëŠ” **ì˜ë£Œì§„ê³¼ ìƒì˜ í›„** ì‚¬ìš©í•´ ì£¼ì„¸ìš”.",
        ])

    # ìƒê¸°ë„/ë…ê° ê³„ì—´
    if score.get("ìƒê¸°ë„/ë…ê° ê³„ì—´", 0) > 0 or cough in ["ì¡°ê¸ˆ", "ë³´í†µ", "ì‹¬í•¨"] or fever not in ["ì—†ìŒ", "37~37.5 (ë¯¸ì—´)"]:
        _box("ğŸ¤§ ìƒê¸°ë„/ë…ê° ê³„ì—´ â€” ì§‘ì—ì„œ", [
            "ë¯¸ì˜¨ìˆ˜ ìì£¼ ë§ˆì‹œê¸°, ì¶©ë¶„í•œ íœ´ì‹ì´ ë„ì›€ì´ ë©ë‹ˆë‹¤.",
            "ì½§ë¬¼ì´ ë§ìœ¼ë©´ ìƒë¦¬ì‹ì—¼ìˆ˜ ì„¸ì²™ í›„ ì•ˆì „í•˜ê²Œ í¡ì¸í•´ìš”.",
            "ê¸°ì¹¨ì´ ì‹¬í•˜ë©´ ë”°ëœ»í•œ ìŒë£Œê°€ ì¡°ê¸ˆ í¸ì•ˆí•¨ì„ ì¤„ ìˆ˜ ìˆì–´ìš”. ìš•ì‹¤ ìŠ¤íŒ€ì€ ì§§ê²Œë§Œ í•´ìš”.",
            "í•´ì—´ì œëŠ” ì•ˆë‚´ëœ ê°„ê²©ê³¼ ìš©ëŸ‰ì„ ì§€ì¼œ ì£¼ì„¸ìš”.",
        ])

    # ë°œì—´ 38â„ƒ ì „í›„ â€” ì§‘ì—ì„œ
    if fever in ["38~38.5", "38.5~39", "39 ì´ìƒ"]:
        _box("ğŸŒ¡ï¸ ë°œì—´ 38â„ƒ ì „í›„ â€” ì§‘ì—ì„œ", [
            "ì‹¤ë‚´ ì˜¨ë„ë¥¼ ì•½ 25â€“26â„ƒë¡œ ìœ ì§€í•´ ì£¼ì„¸ìš”(ë„ˆë¬´ ì¶¥ê±°ë‚˜ ë¥ì§€ ì•Šê²Œ).",
            "ë¯¸ì§€ê·¼í•œ ë¬¼ë¡œ ëª¸ì„ ë¶€ë“œëŸ½ê²Œ ë‹¦ì•„ì£¼ë©´ ì—´ ë‚´ë ¤ê°€ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”(ì°¨ê°€ìš´ ì°œì§ˆì€ í”¼í•´ìš”).",
            "ë¯¸ì˜¨ìˆ˜ë‚˜ ORSë¥¼ **ì¡°ê¸ˆì”© ìì£¼** ë§ˆì‹œë„ë¡ í•´ ì£¼ì„¸ìš”(í•œ ë²ˆì— ë§ì´ X).",
            "ì†ë°œì„ ë§Œì ¸ ë³´ì„¸ìš”. ì†ë°œì´ **ë”°ëœ»**í•˜ë©´ ì—´ì´ ì¡íˆëŠ” ì¤‘ì¼ ìˆ˜ ìˆì–´ìš”.",
            "ì†ë°œì´ **ì°¨ê°€ìš°ë©´** ì•„ì§ í•´ì—´ì œ íš¨ê³¼ê°€ ë‚˜íƒ€ë‚˜ê¸° ì „ì¼ ìˆ˜ ìˆì–´ìš”. **30â€“60ë¶„ ë’¤ ì²´ì˜¨ì„ ë‹¤ì‹œ í™•ì¸**í•´ ì£¼ì„¸ìš”.",
            "í•´ì—´ì œ ê°„ê²©ì€ **APAP 4ì‹œê°„ ì´ìƒ**, **IBU 6ì‹œê°„ ì´ìƒ**ì„ ì§€ì¼œ ì£¼ì„¸ìš”(ì¤‘ë³µ ë³µìš©ì€ í”¼í•©ë‹ˆë‹¤).",
        ])

    # íƒˆìˆ˜/ì‹ ì¥ ë¬¸ì œ
    if score.get("íƒˆìˆ˜/ì‹ ì¥ ë¬¸ì œ", 0) > 0 or oliguria:
        _box("ğŸš° íƒˆìˆ˜/ì‹ ì¥ ë¬¸ì œ â€” ì§‘ì—ì„œ", [
            "ì…ìˆ Â·í˜€ ë§ˆë¦„, ëˆˆë¬¼ ê°ì†Œ, ì†Œë³€ëŸ‰ ë³€í™”ë¥¼ ì£¼ì˜ ê¹Šê²Œ ì‚´í´ë´ ì£¼ì„¸ìš”.",
            "ì†Œë³€ì´ 6â€“8ì‹œê°„ ì´ìƒ ì—†ìœ¼ë©´ ì§„ë£Œê°€ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”.",
            "êµ¬í† ê°€ ìˆìœ¼ë©´ 10â€“15ë¶„ ì‰¬ì—ˆë‹¤ê°€ ORSë¥¼ ë‹¤ì‹œ ì†ŒëŸ‰ì”© ì‹œë„í•´ìš”.",
        ])

    # ì¶œí˜ˆì„± ê²½í–¥
    if score.get("ì¶œí˜ˆì„± ê²½í–¥", 0) > 0:
        _box("ğŸ©¸ ì¶œí˜ˆì„± ê²½í–¥ â€” ì§‘ì—ì„œ", [
            "ì–‘ì¹˜Â·ì½§ì† ì„¸ì²™ì€ ë¶€ë“œëŸ½ê²Œ í•´ ì£¼ì„¸ìš”. ì½” í’€ ë•ŒëŠ” í•œìª½ì”© ì²œì²œíˆ.",
            "ì ìƒì¶œí˜ˆ/ë©ì´ ëŠ˜ê±°ë‚˜ ì½”í”¼ê°€ 10ë¶„ ì´ìƒ ì´ì–´ì§€ë©´ ì§„ë£Œë¥¼ ê¶Œí•´ìš”.",
            "ì¶œí˜ˆ ì„±í–¥ì´ ìˆìœ¼ë©´ ì´ë¶€í”„ë¡œíœì€ í”¼í•˜ê³ , í•´ì—´ì€ APAP ìœ„ì£¼ê°€ ì•ˆì „í•´ìš”.",
        ])

    # ì¤‘ì´ì—¼/ê·€ì§ˆí™˜
    if score.get("ì¤‘ì´ì—¼/ê·€ì§ˆí™˜", 0) > 0 or ear_pain:
        _box("ğŸ‘‚ ì¤‘ì´ì—¼/ê·€ì§ˆí™˜ â€” ì§‘ì—ì„œ", [
            "í†µì¦ ì¡°ì ˆì€ ì§€ì‹œëœ í•´ì—´Â·ì§„í†µì œ ê°„ê²©ì„ ì§€ì¼œì£¼ì„¸ìš”.",
            "ì½”ë§‰í˜ì´ ì‹¬í•˜ë©´ ìƒë¦¬ì‹ì—¼ìˆ˜ ì„¸ì²™ì´ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”.",
            "ê·€ ì•ˆì— ë¬¼ì„ ë„£ê±°ë‚˜ ë©´ë´‰ì„ ê¹Šê²Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ í”¼í•´ì£¼ì„¸ìš”.",
        ])

    # í”¼ë¶€ë°œì§„/ê²½ë¯¸í•œ ì•Œë ˆë¥´ê¸°
    if score.get("í”¼ë¶€ë°œì§„/ê²½ë¯¸í•œ ì•Œë ˆë¥´ê¸°", 0) > 0 or rash or hives:
        _box("ğŸŒ¿ í”¼ë¶€ë°œì§„/ê°€ë²¼ìš´ ì•Œë ˆë¥´ê¸° â€” ì§‘ì—ì„œ", [
            "ë¯¸ì§€ê·¼í•œ ë¬¼ë¡œ ì§§ê²Œ ìƒ¤ì›Œí•˜ê³ , ë³´ìŠµì œë¥¼ ë°œë¼ì£¼ì„¸ìš”.",
            "ë©´ ì†Œì¬ ì˜·ì´ í¸ì•ˆí•´ìš”. ê¸ì§€ ì•Šë„ë¡ ì†í†±ì„ ì •ë¦¬í•´ ì£¼ì„¸ìš”.",
            "ìƒˆ ì„¸ì œ/ìŒì‹ ë…¸ì¶œì´ ìˆì—ˆë‹¤ë©´ ì ì‹œ ì¤‘ë‹¨í•´ ë³´ì„¸ìš”. í˜¸í¡ê³¤ë€Â·ì…ìˆ ë¶€ì¢…ì€ ì¦‰ì‹œ ì§„ë£Œê°€ í•„ìš”í•´ìš”.",
        ])

    # ë³µí†µ í‰ê°€
    if score.get("ë³µí†µ í‰ê°€", 0) > 0 or abd_pain:
        _box("ğŸ¤¢ ë³µí†µ â€” ì§‘ì—ì„œ", [
            "ë°°ë§ˆì‚¬ì§€ ê±°ë¶€, êµ­ì†Œ ì••í†µ, êµ¬ë¶€ì •í•œ ìì„¸ê°€ ê³„ì†ë˜ë©´ ì•…í™” ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”.",
            "ìê·¹ì´ ì ê³  ì†Œí™”ê°€ ì‰¬ìš´ ìŒì‹ë¶€í„° ì²œì²œíˆ ë“œì…”ë³´ì„¸ìš”.",
            "í˜ˆë³€Â·ë‹´ì¦™ì„± êµ¬í† Â·ê³ ì—´ì´ í•¨ê»˜ ë³´ì´ë©´ ë°”ë¡œ ì§„ë£Œë¥¼ ê¶Œí•´ìš”.",
        ])

    # ì•Œë ˆë¥´ê¸° ì£¼ì˜
    if score.get("ì•Œë ˆë¥´ê¸° ì£¼ì˜", 0) > 0:
        _box("âš ï¸ ì•Œë ˆë¥´ê¸° â€” ì§‘ì—ì„œ", [
            "ìƒˆë¡œìš´ ìŒì‹Â·ì•½ ë³µìš© ì—¬ë¶€ë¥¼ ë©”ëª¨í•´ ë‘ë©´ ì§„ë£Œì— ë„ì›€ì´ ë¼ìš”.",
            "ì…ìˆ Â·í˜€Â·ëª© ë¶€ì¢…, ìˆ¨ ê°€ì¨, ì‰°ëª©ì†Œë¦¬ëŠ” ì¦‰ì‹œ ì‘ê¸‰ì‹¤ì´ ì¢‹ì•„ìš”.",
        ])

    # í¸ë‘í†µ ì˜ì‹¬
    if score.get("í¸ë‘í†µ ì˜ì‹¬", 0) > 0 or migraine:
        _box("ğŸ§  í¸ë‘í†µ â€” ì§‘ì—ì„œ", [
            "ì¡°ìš©í•˜ê³  ì–´ë‘ìš´ í™˜ê²½ì—ì„œ ì‰¬ê³ , ìˆ˜ë¶„ì„ ë³´ì¶©í•´ ì£¼ì„¸ìš”.",
            "ë¹›Â·ì†Œë¦¬ ìê·¹ì„ ì¤„ì´ë©´ í¸ì•ˆí•´ì§ˆ ìˆ˜ ìˆì–´ìš”.",
            "ê°‘ì‘ìŠ¤ëŸ½ê³  ë§¤ìš° ì‹¬í•œ ë‘í†µì´ë‚˜ ì‹ ê²½í•™ì  ì¦ìƒì´ ë³´ì´ë©´ ë°”ë¡œ ì§„ë£Œê°€ í•„ìš”í•´ìš”.",
        ])

    # ìˆ˜ì¡±êµ¬ ì˜ì‹¬
    if score.get("ìˆ˜ì¡±êµ¬ ì˜ì‹¬", 0) > 0 or hfmd:
        _box("ğŸ–ï¸ ìˆ˜ì¡±êµ¬ â€” ì§‘ì—ì„œ", [
            "ì†ë°œÂ·ì… ë³‘ë³€ìœ¼ë¡œ í†µì¦ì´ ìˆì„ ìˆ˜ ìˆì–´ìš”. ë¶€ë“œëŸ½ê³  ì°¨ê°€ìš´ ìŒì‹ì´ í¸í•  ìˆ˜ ìˆì–´ìš”.",
            "ìê·¹ì ì¸ ìŒì‹ì€ ì ì‹œ í”¼í•˜ê³ , ìˆ˜ë¶„ì„ ì¶©ë¶„íˆ ë³´ì¶©í•´ ì£¼ì„¸ìš”.",
            "íƒˆìˆ˜ ì‹ í˜¸(ì†Œë³€ ê°ì†Œ, ì… ë§ˆë¦„)ê°€ ë³´ì´ë©´ ì§„ë£Œë¥¼ ê¶Œí•´ìš”.",
        ])

    # (ë³„ë„ ì„ê³„ì¹˜) ì•„ë°ë…¸ë°”ì´ëŸ¬ìŠ¤ ê°€ëŠ¥ì„±
    # ì¡°ê±´: ê²°ë§‰ì—¼ ì ìˆ˜â‰¥30 ë˜ëŠ” ëˆˆ ì†Œê²¬(ë…¸ë‘-ë†ì„±/ì–‘ìª½) + (38â„ƒ ì´ìƒ ë°œì—´) + ìƒê¸°ë„ ì ìˆ˜â‰¥20 ë˜ëŠ” ê¸°ì¹¨ ë³´í†µ/ì‹¬í•¨
    aden_eye = (eye in ["ë…¸ë‘-ë†ì„±", "ì–‘ìª½"]) or (score.get("ê²°ë§‰ì—¼ ì˜ì‹¬", 0) >= 30)
    aden_fever = fever in ["38~38.5", "38.5~39", "39 ì´ìƒ"]
    aden_uri = (score.get("ìƒê¸°ë„/ë…ê° ê³„ì—´", 0) >= 20) or (cough in ["ë³´í†µ", "ì‹¬í•¨"])
    if aden_eye and aden_fever and aden_uri:
        _box("ğŸ§¬ ì•„ë°ë…¸ë°”ì´ëŸ¬ìŠ¤ ê°€ëŠ¥ì„± â€” ì°¸ê³ ", [
            "ì—¬ëŸ¬ ì†Œê²¬ì´ í•¨ê»˜ ë³´ì¼ ë•Œ ê°€ëŠ¥ì„±ì„ ì˜ì‹¬í•´ ë³¼ ìˆ˜ ìˆì–´ìš”.",
            "ê°€ì •ì—ì„œëŠ” í™•ì§„ì´ ì–´ë µê¸° ë•Œë¬¸ì—, ì¦ìƒì´ ì´ì–´ì§€ë©´ ì§„ë£Œì—ì„œ í™•ì¸ë°›ëŠ” ê²ƒì„ ê¶Œí•´ìš”.",
            "ì† ìœ„ìƒê³¼ ê°œì¸ ë¬¼í’ˆ ë¶„ë¦¬ëŠ” ì „íŒŒë¥¼ ì¤„ì´ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.",
        ])

    st.markdown("---")
    _box("ğŸ”´ ë°”ë¡œ ì§„ë£Œ/ì—°ë½ì´ ì¢‹ì•„ìš”", [
        "ì²´ì˜¨ **38.5â„ƒ ì´ìƒì´ ê³„ì†ë˜ê±°ë‚˜ 39â„ƒ ì´ìƒ**ì¼ ë•Œ",
        "ì§€ì† êµ¬í† (>6ì‹œê°„), **ì†Œë³€ëŸ‰ ê¸‰ê°**, ì¶• ëŠ˜ì–´ì§/ì˜ì‹ íë¦¼ì´ ë³´ì¼ ë•Œ",
        "í˜¸í¡ì´ í˜ë“¤ê±°ë‚˜ í‘¸ë¥´ìŠ¤ë¦„í•´ ë³´ì´ê±°ë‚˜, ì…ìˆ Â·í˜€ê°€ ë¶“ëŠ” ëŠë‚Œì´ ë“¤ ë•Œ",
        "í˜ˆë³€/ê²€ì€ ë³€, ëˆˆ ë¶„ë¹„ë¬¼ì´ **ë†ì„± + ì–‘ìª½**ìœ¼ë¡œ ì‹¬í•  ë•Œ",
        "í™œë ¥ì§•í›„(ë§¥ë°•Â·í˜¸í¡Â·ì˜ì‹)ë¥¼ ì‚´í´ ì£¼ì„¸ìš”. **ì²˜ì§**ì´ë‚˜ **ê²½ë ¨ ë³‘ë ¥/ì˜ì‹¬**ì´ ë³´ì´ë©´ ì§€ì²´ ì—†ì´ ë³‘ì› ì§„ë£Œê°€ ì¢‹ì•„ìš”.",
    ])
    st.caption(":red[ì‘ê¸‰ì´ ì˜ì‹¬ë˜ë©´ ì§€ì²´í•˜ì§€ ë§ê³  119 ë˜ëŠ” ê°€ê¹Œìš´ ì‘ê¸‰ì‹¤ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.]")

def render_caregiver_notes_peds(
    stool, fever, persistent_vomit, oliguria, cough, nasal, eye, abd_pain, ear_pain, rash, hives, migraine, hfmd
):
    # ê°„ë‹¨ ì ìˆ˜í™”(ì˜ˆì‹œ)
    score = {
        "ì¥ì—¼ ì˜ì‹¬": 40 if stool in ["3~4íšŒ", "5~6íšŒ", "7íšŒ ì´ìƒ"] else 0,
        "ê²°ë§‰ì—¼ ì˜ì‹¬": 30 if eye in ["ë…¸ë‘-ë†ì„±", "ì–‘ìª½"] else 0,
        "ìƒê¸°ë„/ë…ê° ê³„ì—´": 20 if (cough in ["ì¡°ê¸ˆ", "ë³´í†µ", "ì‹¬í•¨"] or fever in ["38~38.5","38.5~39","39 ì´ìƒ"]) else 0,
        "íƒˆìˆ˜/ì‹ ì¥ ë¬¸ì œ": 20 if oliguria else 0,
        "ì¶œí˜ˆì„± ê²½í–¥": 0,
        "ì¤‘ì´ì—¼/ê·€ì§ˆí™˜": 10 if ear_pain else 0,
        "í”¼ë¶€ë°œì§„/ê²½ë¯¸í•œ ì•Œë ˆë¥´ê¸°": 10 if (rash or hives) else 0,
        "ë³µí†µ í‰ê°€": 10 if abd_pain else 0,
        "ì•Œë ˆë¥´ê¸° ì£¼ì˜": 5 if hives else 0,
        "í¸ë‘í†µ ì˜ì‹¬": 10 if migraine else 0,
        "ìˆ˜ì¡±êµ¬ ì˜ì‹¬": 10 if hfmd else 0,
    }
    ordered = sorted(score.items(), key=lambda x: x[1], reverse=True)
    st.write("â€¢ " + " / ".join([f"{k}: {v}" for k, v in ordered if v > 0]))

    # ìƒì„¸ ê°€ì´ë“œ
    _peds_homecare_details_soft(
        score=score, stool=stool, fever=fever, cough=cough, eye=eye,
        oliguria=oliguria, ear_pain=ear_pain, rash=rash, hives=hives,
        abd_pain=abd_pain, migraine=migraine, hfmd=hfmd
    )

# ============================
# Tabs
# ============================
tab_labels = ["HOME", "ì†Œì•„"]
t_home, t_peds = st.tabs(tab_labels)

# ---- HOME (ë©”ì¸: í”„ë¦¬ì…‹ë§Œ ë…¸ì¶œ) ----
with t_home:
    st.subheader("ì‘ê¸‰ë„ ê°€ì¤‘ì¹˜ (í¸ì§‘ + í”„ë¦¬ì…‹)")

    left, mid, right = st.columns([1.5, 1, 1])
    with left:
        preset_name = st.selectbox("í”„ë¦¬ì…‹ ì„ íƒ", list(PRESETS.keys()), index=0, key=wkey("preset_sel"))
    with mid:
        if st.button("í”„ë¦¬ì…‹ ì ìš©", key=wkey("preset_apply")):
            base = PRESETS.get(preset_name, {})
            set_weights(base)
            st.success("í”„ë¦¬ì…‹ì„ ì ìš©í–ˆì–´ìš”.")
    with right:
        if st.button("ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”", key=wkey("preset_reset")):
            set_weights({})
            st.info("ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.")

    W = get_weights()
    with st.expander("í˜„ì¬ ê°€ì¤‘ì¹˜ ë³´ê¸°(ì½ê¸° ì „ìš©)", expanded=False):
        try:
            st.json({k: float(W.get(k, 1.0)) for k in sorted(W.keys())})
        except Exception:
            st.write(W)
    st.caption("ë©”ì¸ í™”ë©´ì—ì„œëŠ” í”„ë¦¬ì…‹ë§Œ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”. ì„¸ë¶€ ê°€ì¤‘ì¹˜ ìŠ¬ë¼ì´ë”ëŠ” ìˆ¨ê²¼ìŠµë‹ˆë‹¤.")

    st.divider()
    # í™ˆ CTA: ì†Œì•„ íƒ­ìœ¼ë¡œ ì´ë™
    cta = st.button("ğŸ‘¶ ì†Œì•„ ì¦ìƒ â†’ ë°”ë¡œ ì•ˆë‚´", use_container_width=True)
    if cta:
        st.components.v1.html("""
        <script>
          const tabs = Array.from(parent.document.querySelectorAll('button[role="tab"]'));
          const target = tabs.find(b => /ì†Œì•„/.test(b.textContent));
          if (target){ target.click(); }
        </script>
        """, height=0)

# ---- PEDS ----
with t_peds:
    st.subheader("ì†Œì•„ ë³´í˜¸ì ê°€ì´ë“œ (ì¦ìƒ ì…ë ¥ â†’ ìë™ ì•ˆë‚´)")

    c1, c2, c3, c4, c5 = st.columns(5)
    with c1:
        nasal = st.selectbox("ì½§ë¬¼", ["í•´ë‹¹ ì—†ìŒ", "ë§‘ìŒ", "ëˆì "], index=0, key=wkey("p_nasal"))
    with c2:
        cough = st.selectbox("ê¸°ì¹¨", ["ì—†ìŒ", "ì¡°ê¸ˆ", "ë³´í†µ", "ì‹¬í•¨"], index=0, key=wkey("p_cough"))
    with c3:
        stool = st.selectbox("ì„¤ì‚¬", ["í•´ë‹¹ ì—†ìŒ", "1~2íšŒ", "3~4íšŒ", "5~6íšŒ", "7íšŒ ì´ìƒ"], index=0, key=wkey("p_stool"))
    with c4:
        fever = st.selectbox("ë°œì—´", ["ì—†ìŒ", "37~37.5 (ë¯¸ì—´)", "38~38.5", "38.5~39", "39 ì´ìƒ"], index=0, key=wkey("p_fever"))
    with c5:
        eye = st.selectbox("ëˆˆê¼½/ê²°ë§‰", ["í•´ë‹¹ ì—†ìŒ", "ë§‘ìŒ", "ì–‘ìª½", "ë…¸ë‘-ë†ì„±"], index=0, key=wkey("p_eye"))

    r1, r2, r3 = st.columns(3)
    with r1:
        abd_pain = st.checkbox("ë³µí†µ/ì••í†µ", key=wkey("p_abd_pain"))
        ear_pain = st.checkbox("ê·€ í†µì¦/ë§Œì§€ë©´ ìš¸ìŒ", key=wkey("p_ear_pain"))
        rash = st.checkbox("í”¼ë¶€ ë°œì§„", key=wkey("p_rash"))
    with r2:
        hives = st.checkbox("ë‘ë“œëŸ¬ê¸°", key=wkey("p_hives"))
        migraine = st.checkbox("í¸ë‘í†µ ì˜ì‹¬", key=wkey("p_migraine"))
        hfmd = st.checkbox("ìˆ˜ì¡±êµ¬ ì˜ì‹¬", key=wkey("p_hfmd"))
    with r3:
        persistent_vomit = st.checkbox("ì§€ì† êµ¬í† (>6ì‹œê°„)", key=wkey("p_pvomit"))
        oliguria = st.checkbox("ì†Œë³€ëŸ‰ ê¸‰ê°", key=wkey("p_oliguria"))

    # ìë™ í•´ì„: ì¦‰ì‹œ ë³´í˜¸ì ê°€ì´ë“œ í‘œì‹œ
    render_caregiver_notes_peds(
        stool=stool, fever=fever, persistent_vomit=persistent_vomit, oliguria=oliguria,
        cough=cough, nasal=nasal, eye=eye, abd_pain=abd_pain, ear_pain=ear_pain,
        rash=rash, hives=hives, migraine=migraine, hfmd=hfmd
    )
