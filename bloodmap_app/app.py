
# -*- coding: utf-8 -*-
import streamlit as st
from dataclasses import dataclass, asdict
from typing import Dict, List, Tuple, Optional
from io import BytesIO

# -------- PDF backend (optional) --------
PDF_AVAILABLE = True
try:
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    from reportlab.lib.units import mm
except Exception:
    PDF_AVAILABLE = False

# ===================
# Config & Data
# ===================

APP_TITLE = "ü©∏ ÌîºÏàòÏπò Í∞ÄÏù¥Îìú / BloodMap"
APP_SIGNATURE = "Ï†úÏûë: Hoya/GPT ¬∑ ÏûêÎ¨∏: Hoya/GPT"

SARCOMA_LIST = [
    "Ewing", "Osteosarcoma", "Synovial", "Leiomyosarcoma",
    "Liposarcoma", "Rhabdomyosarcoma"
]

SOLID_LIST = ["Lung", "Breast", "Colon", "Stomach", "Liver", "Pancreas", "Cholangiocarcinoma"]

HEMATO_LIST = ["AML", "APL", "ALL", "CML", "CLL"]

# Ìï≠ÏïîÏ†ú/Ìï≠ÏÉùÏ†ú ‚Äî ÌïúÍ∏Ä Î≥ëÍ∏∞
CHEMO_BY_DX: Dict[str, List[str]] = {
    "AML": ["ÏïÑÎùºÏî®(ARA-C)", "ÎèÑÏö∞ÎÖ∏Î£®ÎπÑÏã†(Daunorubicin)", "ÏóêÌÜ†Ìè¨ÏÇ¨Ïù¥Îìú(Etoposide)"],
    "APL": ["ÏïÑÌä∏Îùº(ATRA, Ìä∏Î†àÌã∞ÎÖ∏Ïù∏)", "ÏïÑÏÇ∞ÌôîÎπÑÏÜå(ATO)", "MTX(Î©îÌÜ†Ìä∏Î†âÏÑ∏Ïù¥Ìä∏)", "6-MP(6-Î®∏Ï∫ÖÌÜ†Ìì®Î¶∞)"],
    "ALL": ["ÎπàÌÅ¨Î¶¨Ïä§Ìã¥(Vincristine)", "ÏÇ¨Ïù¥ÌÅ¥Î°úÌè¨Ïä§ÌååÎßàÏù¥Îìú(Cyclophosphamide)", "MTX(Î©îÌÜ†Ìä∏Î†âÏÑ∏Ïù¥Ìä∏)"],
    "CML": ["Ïù¥ÎßàÌã∞Îãô(Imatinib)"],
    "CLL": ["ÌîåÎ£®Îã§ÎùºÎπà(Fludarabine)"],
}
CHEMO_COMMON = ["Í∑∏ÎùºÏã†(G-CSF)"]

ANTIBIOTICS_COMMON = [
    "ÏÑ∏ÌîÑÌä∏Î¶¨ÏïÖÏÜê(ceftriaxone)", "ÌîºÌéòÎùºÏã§Î¶∞/ÌÉÄÏ°∞Î∞ïÌÉê(piperacillin/tazobactam)",
    "Î©îÎ°úÌéòÎÑ¥(meropenem)", "Î†àÎ≥¥ÌîåÎ°ùÏÇ¨Ïã†(levofloxacin)"
]

# ÏãùÏù¥Í∞ÄÏù¥Îìú (Í∞Å 5Í∞ú)
DIET_GUIDES = {
    "Albumin_low": ["Îã¨Í±Ä", "Ïó∞ÎëêÎ∂Ä", "Ìù∞ÏÇ¥ ÏÉùÏÑ†", "Îã≠Í∞ÄÏä¥ÏÇ¥", "Í∑ÄÎ¶¨Ï£Ω"],
    "K_low": ["Î∞îÎÇòÎÇò", "Í∞êÏûê", "Ìò∏Î∞ïÏ£Ω", "Í≥†Íµ¨Îßà", "Ïò§Î†åÏßÄ"],
    "Hb_low": ["ÏÜåÍ≥†Í∏∞", "ÏãúÍ∏àÏπò", "ÎëêÎ∂Ä", "Îã¨Í±Ä ÎÖ∏Î•∏Ïûê", "Î†åÌã∏ÏΩ©"],
    "Na_low": ["Ï†ÑÌï¥Ïßà ÏùåÎ£å", "ÎØ∏Ïó≠Íµ≠", "Î∞îÎÇòÎÇò", "Ïò§Ìä∏Î∞ÄÏ£Ω", "ÏÇ∂ÏùÄ Í∞êÏûê"],
    "Ca_low": ["Ïó∞Ïñ¥ÌÜµÏ°∞Î¶º", "ÎëêÎ∂Ä", "ÏºÄÏùº", "Î∏åÎ°úÏΩúÎ¶¨", "(Ï∞∏Íπ® Ï†úÏô∏)"],
}
NEUTROPENIA_FOOD_SAFETY = [
    "ÏÉùÏ±ÑÏÜå Í∏àÏßÄ, Ï∂©Î∂ÑÌûà ÏùµÌòÄÏÑú ÏÑ≠Ï∑®",
    "ÎÇ®ÏùÄ ÏùåÏãùÏùÄ 2ÏãúÍ∞Ñ Ïù¥ÌõÑ ÏÑ≠Ï∑®ÌïòÏßÄ ÏïäÍ∏∞",
    "Î©∏Í∑†/ÏÇ¥Í∑† Ï†úÌíà Í∂åÏû•",
    "ÍªçÏßà ÏûàÎäî Í≥ºÏùºÏùÄ Ï£ºÏπòÏùòÏôÄ ÏÉÅÎã¥ ÌõÑ Í≤∞Ï†ï",
]

# ===================
# Helpers
# ===================

def _parse_conc_to_mg_per_ml(conc_label: str) -> Optional[float]:
    try:
        c = conc_label.replace("mL", "ml").replace("ML", "ml")
        mg_part, ml_part = c.split("mg/")
        mg = float(mg_part.strip().split()[-1])
        ml = float(ml_part.strip().split()[0])
        if ml == 0:
            return None
        return mg / ml
    except Exception:
        return None

def _round_ml(x: float, step: float = 0.5) -> Optional[float]:
    try:
        return round(round(x / step) * step, 2)
    except Exception:
        return None

def dose_ml_acetaminophen(weight_kg, conc_label: str, mg_per_kg: float = 12.5, step: float = 0.5):
    try:
        w = float(weight_kg)
        mg_per_ml = _parse_conc_to_mg_per_ml(conc_label)
        if mg_per_ml is None or w <= 0:
            return None
        ml = (w * mg_per_kg) / mg_per_ml
        return _round_ml(ml, step)
    except Exception:
        return None

def dose_ml_ibuprofen(weight_kg, conc_label: str, mg_per_kg: float = 7.5, step: float = 0.5):
    try:
        w = float(weight_kg)
        mg_per_ml = _parse_conc_to_mg_per_ml(conc_label)
        if mg_per_ml is None or w <= 0:
            return None
        ml = (w * mg_per_kg) / mg_per_ml
        return _round_ml(ml, step)
    except Exception:
        return None

def build_sections_md(sections: List[Tuple[str, List[str]]]) -> str:
    md = []
    for title, lines in sections:
        md.append(f"## {title}")
        for ln in lines:
            if ln.strip():
                if ln.startswith("- "):
                    md.append(ln)
                else:
                    md.append(f"- {ln}")
        md.append("")
    return "\n".join(md).strip() + "\n"

def build_txt(md_text: str) -> str:
    out = []
    for line in md_text.splitlines():
        if line.startswith("## "):
            out.append(line[3:])
            out.append("-" * len(line[3:]))
        elif line.startswith("- "):
            out.append("‚Ä¢ " + line[2:])
        else:
            out.append(line)
    return "\n".join(out) + "\n"

def build_pdf(md_text: str) -> Optional[bytes]:
    if not PDF_AVAILABLE:
        return None
    buffer = BytesIO()
    c = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    left = 15 * mm
    top = height - 15 * mm
    max_width = width - 30 * mm

    def draw_wrapped(text: str, y: float, font="Helvetica", size=11):
        c.setFont(font, size)
        words = text.split(" ")
        line = ""
        while words:
            w = words.pop(0)
            test = (line + " " + w).strip()
            if c.stringWidth(test, font, size) <= max_width:
                line = test
            else:
                c.drawString(left, y, line)
                y -= 14
                line = w
                if y < 20 * mm:
                    c.showPage(); y = height - 20 * mm
        if line:
            c.drawString(left, y, line); y -= 14
        return y

    y = top
    for raw in md_text.splitlines():
        if raw.startswith("## "):
            y = draw_wrapped(raw[3:], y, font="Helvetica-Bold", size=12)
        elif raw.startswith("- "):
            y = draw_wrapped("‚Ä¢ " + raw[2:], y)
        else:
            y = draw_wrapped(raw, y)
        if y < 20 * mm:
            c.showPage(); y = height - 20 * mm

    c.save()
    buffer.seek(0)
    return buffer.getvalue()

# ===================
# Interpretation
# ===================

@dataclass
class Labs:
    wbc: Optional[float] = None
    hb: Optional[float] = None
    plt: Optional[float] = None
    anc: Optional[float] = None
    ca: Optional[float] = None
    p: Optional[float] = None
    na: Optional[float] = None
    k: Optional[float] = None
    albumin: Optional[float] = None
    glucose: Optional[float] = None
    tp: Optional[float] = None
    ast: Optional[float] = None
    alt: Optional[float] = None
    ldh: Optional[float] = None
    crp: Optional[float] = None
    cr: Optional[float] = None
    ua: Optional[float] = None
    tb: Optional[float] = None
    bun: Optional[float] = None
    bnp: Optional[float] = None

def interpret_labs(labs: Labs) -> List[Tuple[str, List[str]]]:
    sections: List[Tuple[str, List[str]]] = []

    # Summary
    summary = []
    for key, label in [
        ("wbc","WBC"), ("hb","Hb"), ("plt","ÌòàÏÜåÌåê"), ("anc","ANC"),
        ("ca","Ca"), ("na","Na"), ("k","K"), ("albumin","Albumin"),
        ("crp","CRP"), ("cr","Cr"), ("bun","BUN"), ("tb","TB"), ("ua","UA"),
    ]:
        v = getattr(labs, key)
        if v is not None:
            summary.append(f"{label}: {v}")
    if summary:
        sections.append(("Í≤ÄÏÇ¨ ÏöîÏïΩ", summary))

    # Diet guide triggers
    diet_lines: List[str] = []
    if labs.albumin is not None and labs.albumin < 3.5:
        diet_lines.append("ÏïåÎ∂ÄÎØº ÎÇÆÏùå ‚Üí Í∂åÏû• ÏãùÌíà: " + ", ".join(DIET_GUIDES["Albumin_low"]))
    if labs.k is not None and labs.k < 3.5:
        diet_lines.append("ÏπºÎ•® ÎÇÆÏùå ‚Üí Í∂åÏû• ÏãùÌíà: " + ", ".join(DIET_GUIDES["K_low"]))
    if labs.hb is not None and labs.hb < 10:
        diet_lines.append("Ìó§Î™®Í∏ÄÎ°úÎπà ÎÇÆÏùå ‚Üí Í∂åÏû• ÏãùÌíà: " + ", ".join(DIET_GUIDES["Hb_low"]))
    if labs.na is not None and labs.na < 135:
        diet_lines.append("ÎÇòÌä∏Î•® ÎÇÆÏùå ‚Üí Í∂åÏû• ÏãùÌíà: " + ", ".join(DIET_GUIDES["Na_low"]))
    if labs.ca is not None and labs.ca < 8.6:
        diet_lines.append("ÏπºÏäò ÎÇÆÏùå ‚Üí Í∂åÏû• ÏãùÌíà: " + ", ".join(DIET_GUIDES["Ca_low"]))

    if labs.anc is not None and labs.anc < 500:
        diet_lines = ["[Ìò∏Ï§ëÍµ¨ ÎÇÆÏùå ‚Äî ÏúÑÏÉù/Ï°∞Î¶¨ ÏïàÏ†Ñ ÏàòÏπô]"] + [f"- {rule}" for rule in NEUTROPENIA_FOOD_SAFETY] + [""] + diet_lines

    if diet_lines:
        sections.append(("ÏãùÏù¥Í∞ÄÏù¥Îìú", diet_lines))

    return sections

# ===================
# UI
# ===================

def main():
    st.set_page_config(page_title="ÌîºÏàòÏπò Í∞ÄÏù¥Îìú / BloodMap", layout="centered")
    st.title(APP_TITLE)
    st.caption(APP_SIGNATURE)

    # Nickname + PIN
    col1, col2 = st.columns([2,1], vertical_alignment="center")
    nickname = col1.text_input("Î≥ÑÎ™Ö", placeholder="Ïòà: Î≥¥Ìò∏ÏûêA")
    pin = col2.text_input("PIN 4ÏûêÎ¶¨", max_chars=4, placeholder="0000")
    if pin and not pin.isdigit():
        st.warning("PINÏùÄ Ïà´Ïûê 4ÏûêÎ¶¨Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.")
    key_id = f"{nickname}#{pin}" if nickname and pin and pin.isdigit() and len(pin)==4 else None

    # Disease selection
    st.divider()
    st.subheader("Ïïî Í∑∏Î£π / ÏßÑÎã®")
    grp = st.selectbox("Í∑∏Î£π", ["ÌòàÏï°Ïïî", "Ïú°Ï¢Ö(ÏßÑÎã®Î™Ö Î∂ÑÎ¶¨)", "Í≥†ÌòïÏïî(Í∏∞ÌÉÄ)"])
    if grp == "ÌòàÏï°Ïïî":
        dx = st.selectbox("ÏßÑÎã®Î™Ö", HEMATO_LIST)
    elif grp == "Ïú°Ï¢Ö(ÏßÑÎã®Î™Ö Î∂ÑÎ¶¨)":
        dx = st.selectbox("Ïú°Ï¢Ö ÏÑ∏Î∂Ä", SARCOMA_LIST)
    else:
        dx = st.selectbox("Í≥†ÌòïÏïî", SOLID_LIST)

    # Labs
    st.divider()
    st.subheader("ÌîºÏàòÏπò ÏûÖÎ†•")
    c1, c2, c3, c4 = st.columns(4)
    with c1:
        wbc = st.number_input("WBC", min_value=0.0, step=0.1, format="%.1f")
        hb = st.number_input("Hb", min_value=0.0, step=0.1, format="%.1f")
        plt = st.number_input("ÌòàÏÜåÌåê(PLT)", min_value=0.0, step=1.0, format="%.0f")
        anc = st.number_input("ANC(Ìò∏Ï§ëÍµ¨)", min_value=0.0, step=10.0, format="%.0f")
        ca = st.number_input("Ca", min_value=0.0, step=0.1, format="%.1f")
    with c2:
        p = st.number_input("P(Ïù∏)", min_value=0.0, step=0.1, format="%.1f")
        na = st.number_input("Na", min_value=0.0, step=0.5, format="%.1f")
        k = st.number_input("K", min_value=0.0, step=0.1, format="%.1f")
        albumin = st.number_input("Albumin", min_value=0.0, step=0.1, format="%.1f")
        glucose = st.number_input("Glucose", min_value=0.0, step=1.0, format="%.0f")
    with c3:
        tp = st.number_input("Total Protein", min_value=0.0, step=0.1, format="%.1f")
        ast = st.number_input("AST", min_value=0.0, step=1.0, format="%.0f")
        alt = st.number_input("ALT", min_value=0.0, step=1.0, format="%.0f")
        ldh = st.number_input("LDH", min_value=0.0, step=1.0, format="%.0f")
        crp = st.number_input("CRP", min_value=0.0, step=0.1, format="%.1f")
    with c4:
        cr = st.number_input("Creatinine(Cr)", min_value=0.0, step=0.01, format="%.2f")
        ua = st.number_input("Uric Acid(UA)", min_value=0.0, step=0.1, format="%.1f")
        tb = st.number_input("Total Bilirubin(TB)", min_value=0.0, step=0.1, format="%.1f")
        bun = st.number_input("BUN", min_value=0.0, step=0.1, format="%.1f")
        bnp = st.number_input("BNP(ÏÑ†ÌÉù)", min_value=0.0, step=1.0, format="%.0f")

    # ÌäπÏàòÍ≤ÄÏÇ¨(ÌîºÏàòÏπò ÏïÑÎûò)
    st.divider()
    st.subheader("ÌäπÏàòÍ≤ÄÏÇ¨ (ÌÜ†Í∏Ä)")
    t1, t2, t3, t4, t5 = st.columns(5)
    with t1:
        tg_c = st.checkbox("Î≥¥Ï≤¥")
    with t2:
        tg_u = st.checkbox("ÏöîÍ≤ÄÏÇ¨/Îã®Î∞±Îá®")
    with t3:
        tg_coag = st.checkbox("ÏùëÍ≥†")
    with t4:
        tg_lip = st.checkbox("ÏßÄÏßà")
    with t5:
        tg_etc = st.checkbox("Í∏∞ÌÉÄ")

    if tg_c:
        st.markdown("**Î≥¥Ï≤¥**")
        c_c1, c_c2, c_c3 = st.columns(3)
        C3 = c_c1.number_input("C3", min_value=0.0, step=0.1, format="%.1f")
        C4 = c_c2.number_input("C4", min_value=0.0, step=0.1, format="%.1f")
        CH50 = c_c3.number_input("CH50", min_value=0.0, step=0.1, format="%.1f")

    if tg_u:
        st.markdown("**ÏöîÍ≤ÄÏÇ¨/Îã®Î∞±Îá®**")
        u1, u2, u3, u4 = st.columns(4)
        hematuria = u1.selectbox("ÌòàÎá®", ["Î™®Î¶Ñ","ÏùåÏÑ±","ÎØ∏ÏÑ∏","Ïú°ÏïàÏ†Å"])
        proteinuria = u2.selectbox("Îã®Î∞±Îá®", ["Î™®Î¶Ñ","ÏùåÏÑ±","ÎØ∏ÏÑ∏","+","++","+++"])
        glycosuria = u3.selectbox("ÏöîÎãπ", ["Î™®Î¶Ñ","ÏùåÏÑ±","+","++","+++"])
        acr = u4.number_input("ACR (mg/g)", min_value=0.0, step=1.0, format="%.0f")
        upcr = st.number_input("UPCR (mg/g)", min_value=0.0, step=1.0, format="%.0f")

    if tg_coag:
        st.markdown("**ÏùëÍ≥†**")
        c1, c2, c3 = st.columns(3)
        PT = c1.number_input("PT(sec)", min_value=0.0, step=0.1, format="%.1f")
        INR = c2.number_input("INR", min_value=0.0, step=0.01, format="%.2f")
        aPTT = c3.number_input("aPTT(sec)", min_value=0.0, step=0.1, format="%.1f")

    if tg_lip:
        st.markdown("**ÏßÄÏßà/ÌòàÎãπÎåÄÏÇ¨**")
        l1, l2, l3 = st.columns(3)
        chol = l1.number_input("Ï¥ùÏΩúÎ†àÏä§ÌÖåÎ°§", min_value=0.0, step=1.0, format="%.0f")
        hdl = l2.number_input("HDL", min_value=0.0, step=1.0, format="%.0f")
        tg = l3.number_input("Triglyceride", min_value=0.0, step=1.0, format="%.0f")

    if tg_etc:
        st.markdown("**Í∏∞ÌÉÄ**")
        e1, e2, e3 = st.columns(3)
        tsh = e1.number_input("TSH", min_value=0.0, step=0.01, format="%.2f")
        pct = e2.number_input("Procalcitonin", min_value=0.0, step=0.01, format="%.2f")
        lactate = e3.number_input("Lactate", min_value=0.0, step=0.1, format="%.1f")

    # Pediatric antipyretic quick calc
    st.divider()
    st.subheader("ÏÜåÏïÑ Ìï¥Ïó¥Ï†ú Îπ†Î•∏ Í≥ÑÏÇ∞ (Ï§ëÏïôÍ∞í Í∏∞Ï§Ä, ml Îã®Ïùº ÌëúÍ∏∞)")
    pc1, pc2, pc3 = st.columns([1,1,2])
    with pc1:
        wt = st.number_input("Ï≤¥Ï§ë(kg)", min_value=0.0, step=0.1, format="%.1f")
    with pc2:
        acet_conc = st.selectbox("ÏïÑÏÑ∏Ìä∏ÏïÑÎØ∏ÎÖ∏Ìéú ÎÜçÎèÑ", ["160 mg/5 ml", "120 mg/5 ml"])
        ibu_conc = st.selectbox("Ïù¥Î∂ÄÌîÑÎ°úÌéú ÎÜçÎèÑ", ["100 mg/5 ml"])
    with pc3:
        if wt > 0:
            ml_acet = dose_ml_acetaminophen(wt, acet_conc)
            ml_ibu = dose_ml_ibuprofen(wt, ibu_conc)
            if ml_acet is not None:
                st.info(f"ÏïÑÏÑ∏Ìä∏ÏïÑÎØ∏ÎÖ∏Ìéú Í∂åÏû• 1Ìöå: **{ml_acet:.1f} ml**  (Í∞ÑÍ≤© 4‚Äì6ÏãúÍ∞Ñ, ÌïòÎ£® ÏµúÎåÄ 5Ìöå)")
            if ml_ibu is not None:
                st.info(f"Ïù¥Î∂ÄÌîÑÎ°úÌéú Í∂åÏû• 1Ìöå: **{ml_ibu:.1f} ml**  (Í∞ÑÍ≤© 6‚Äì8ÏãúÍ∞Ñ)")

    # ÏïΩÎ¨º ÏÑ†ÌÉù (Ìï≠ÏïîÏ†ú/Ìï≠ÏÉùÏ†ú)
    st.divider()
    st.subheader("ÏïΩÎ¨º ÏÑ†ÌÉù")
    default_chemo = CHEMO_BY_DX.get(dx, [])
    st.caption("ÏïîÏ¢ÖÏóê ÎßûÎäî Ìï≠ÏïîÏ†úÍ∞Ä Î®ºÏ†Ä Î≥¥Ïù¥Î©∞, ÌïÑÏöî Ïãú Ï∂îÍ∞Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.")
    sel_chemo = st.multiselect("Ìï≠ÏïîÏ†ú(ÌïúÍ∏Ä Î≥ëÍ∏∞)", default_chemo + CHEMO_COMMON, default=default_chemo)
    sel_abx = st.multiselect("Ìï≠ÏÉùÏ†ú(ÌïúÍ∏Ä Î≥ëÍ∏∞)", ANTIBIOTICS_COMMON, default=[])

    # Ìï¥ÏÑùÌïòÍ∏∞
    st.divider()
    go = st.button("üîé Ìï¥ÏÑùÌïòÍ∏∞", type="primary", use_container_width=True)

    if go:
        labs = Labs(
            wbc=wbc or None, hb=hb or None, plt=plt or None, anc=anc or None,
            ca=ca or None, p=p or None, na=na or None, k=k or None,
            albumin=albumin or None, glucose=glucose or None, tp=tp or None,
            ast=ast or None, alt=alt or None, ldh=ldh or None, crp=crp or None,
            cr=cr or None, ua=ua or None, tb=tb or None, bun=bun or None, bnp=bnp or None
        )
        sections = interpret_labs(labs)

        # ÏïΩÎ¨º Í≤ΩÍ≥† ÏöîÏïΩ(Í∞ÑÎã®)
        warn = []
        if "MTX(Î©îÌÜ†Ìä∏Î†âÏÑ∏Ïù¥Ìä∏)" in sel_chemo:
            warn += ["[MTX] Í∞Ñ ÏàòÏπò ÏÉÅÏäπ/Íµ¨ÎÇ¥Ïóº/Í≥®ÏàòÏñµÏ†ú Ï£ºÏùò"]
        if "6-MP(6-Î®∏Ï∫ÖÌÜ†Ìì®Î¶∞)" in sel_chemo:
            warn += ["[6-MP] Í∞ÑÎèÖÏÑ±/Í≥®ÏàòÏñµÏ†ú Ï£ºÏùò"]
        if "ÏïÑÌä∏Îùº(ATRA, Ìä∏Î†àÌã∞ÎÖ∏Ïù∏)" in sel_chemo:
            warn += ["[ATRA] Î∂ÑÌôîÏ¶ùÌõÑÍµ∞, ÎëêÌÜµ/ÌîºÎ∂ÄÏ¶ùÏÉÅ Ï£ºÏùò"]
        if any(x in sel_abx for x in ["Î†àÎ≥¥ÌîåÎ°ùÏÇ¨Ïã†(levofloxacin)"]):
            warn += ["[FQ] Í±¥/Ï§ëÏ∂îÏã†Í≤ΩÍ≥Ñ Ïù¥ÏÉÅ ÎìúÎ¨ºÍ≤å Î≥¥Í≥† ‚Üí Î≥µÏö© Ï§ë Ïù¥ÏÉÅ Ïãú Ï§ëÎã®/ÏÉÅÎã¥"]

        if warn:
            sections.insert(0, ("ÏïΩÎ¨º Ï£ºÏùò ÏöîÏïΩ", warn))

        # ÌôîÎ©¥ ÌëúÏãú
        st.success("Ìï¥ÏÑù ÏôÑÎ£å ‚Äî ÏïÑÎûò Í≤∞Í≥ºÏôÄ ÏãùÏù¥Í∞ÄÏù¥ÎìúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.")
        for title, lines in sections:
            st.subheader(title)
            for ln in lines:
                st.markdown(f"- {ln}")

        # ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (TXT/PDF)
        md_text = build_sections_md(sections)
        txt_text = build_txt(md_text)
        pdf_bytes = build_pdf(md_text) if PDF_AVAILABLE else None

        st.divider()
        st.write("üìÑ Í≤∞Í≥º Ï†ÄÏû•")
        cdl1, cdl2 = st.columns(2)
        cdl1.download_button("TXTÎ°ú Ï†ÄÏû•", data=txt_text.encode("utf-8"), file_name="bloodmap_result.txt", mime="text/plain", use_container_width=True)
        if pdf_bytes is not None:
            cdl2.download_button("PDFÎ°ú Ï†ÄÏû•", data=pdf_bytes, file_name="bloodmap_result.pdf", mime="application/pdf", use_container_width=True)
        else:
            cdl2.button("PDF ÏÉùÏÑ± Î∂àÍ∞Ä (reportlab ÌïÑÏöî)", disabled=True, use_container_width=True)

        # ÏÑ†ÌÉùÏ†ÅÏúºÎ°ú Î°úÏª¨ Ï†ÄÏû• (ÎãâÎÑ§ÏûÑ#PIN)
        if key_id:
            try:
                os.makedirs("data", exist_ok=True)
                stamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
                path = f"data/{key_id}_{stamp}.txt"
                with open(path, "w", encoding="utf-8") as f:
                    f.write(txt_text)
                st.caption(f"Î°úÏª¨ Ï†ÄÏû•Îê®: {path}")
            except Exception:
                st.caption("Î°úÏª¨ Ï†ÄÏû• Ïã§Ìå®(Í∂åÌïú/ÌôòÍ≤Ω Î¨∏Ï†ú).")

if __name__ == "__main__":
    main()
