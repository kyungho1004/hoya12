
import streamlit as st

st.set_page_config(page_title="BloodMap App (Safe Tabs + Peds Guide)", page_icon="ğŸ©º", layout="wide")

# --- Optional banner ---
try:
    from branding import render_deploy_banner
    try:
        render_deploy_banner()
    except Exception:
        st.caption("KST ê¸°ì¤€. ì œì‘/ìë¬¸: Hoya/GPT â€” ê¸°ì¡´ ê¸°ëŠ¥ì€ ë³´ì¡´ë˜ë©°, ì•„ë˜ í•­ëª©ì€ ì•ˆì „í•˜ê²Œ 'ì¶”ê°€'ë§Œ ë©ë‹ˆë‹¤.")
except Exception:
    st.caption("KST ê¸°ì¤€. ì œì‘/ìë¬¸: Hoya/GPT â€” ê¸°ì¡´ ê¸°ëŠ¥ì€ ë³´ì¡´ë˜ë©°, ì•„ë˜ í•­ëª©ì€ ì•ˆì „í•˜ê²Œ 'ì¶”ê°€'ë§Œ ë©ë‹ˆë‹¤.")

# ======================================================
#                 Tabs (ì•ˆì „ ë§µ ë°©ì‹, Bì•ˆ)
# ======================================================
TAB_TITLES = [
    "í™ˆ", "ì†Œì•„", "ê²€ì‚¬ê²°ê³¼", "ë³´ê³ ì„œ", "ë³µì•½/ìš©ë²•", "êµìœ¡/ê°€ì´ë“œ", "ì„¤ì •", "ì§„ë‹¨",
]
_tabs = st.tabs(TAB_TITLES)
TAB_MAP = {title: tab for title, tab in zip(TAB_TITLES, _tabs)}

def _get_tab_safe(*titles):
    for t in titles:
        if t in TAB_MAP:
            return TAB_MAP[t]
    return st.container()

# í‘œì¤€ íƒ­ ë³€ìˆ˜(ë‹¤êµ­ì–´/ë³€í˜• ì»¤ë²„, ì—†ìœ¼ë©´ container ë°˜í™˜)
t_home     = _get_tab_safe("í™ˆ","Home")
t_peds     = _get_tab_safe("ì†Œì•„","Peds","ì†Œì•„ê³¼")
t_labs     = _get_tab_safe("ê²€ì‚¬ê²°ê³¼","Labs","Lab","ê²€ì‚¬")
t_report   = _get_tab_safe("ë³´ê³ ì„œ","Report")
t_meds     = _get_tab_safe("ë³µì•½/ìš©ë²•","ì•½","ì•½ë¬¼","Meds","Medication")
t_edu      = _get_tab_safe("êµìœ¡/ê°€ì´ë“œ","ê°€ì´ë“œ","Edu","Guide")
t_settings = _get_tab_safe("ì„¤ì •","Settings")
t_dx       = _get_tab_safe("ì§„ë‹¨","ì§„ë‹¨/í‰ê°€","Diagnosis","Dx")

# ìµœì¢… ë³´ë£¨: í˜¹ì‹œ ì½”ë“œ ì–´ë”˜ê°€ì—ì„œ ë‹¤ìŒ ë³€ìˆ˜ë“¤ì„ withì— ì“°ë”ë¼ë„ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘ 
for _var in ["t_emerg","t_admin","t_weights","t_triage","t_tools","t_rx","t_dx","t_labs"]:
    if _var not in globals():
        globals()[_var] = st.container()

# ======================================================
#         Weights helpers (uses session_state only)
# ======================================================
DEFAULT_WEIGHTS = {
    # í˜ˆì•¡/ê°ì—¼
    "w_anc_lt500": 1.0, "w_anc_500_999": 1.0, "w_crp_ge10": 1.0,
    "w_hb_lt7": 1.0, "w_plt_lt20k": 1.0,
    # í™œë ¥/ê³ ìœ„í—˜
    "w_temp_38_0_38_4": 1.0, "w_temp_ge_38_5": 1.0, "w_hr_gt130": 1.0,
    "w_dyspnea": 1.0, "w_confusion": 1.0,
    # ì¶œí˜ˆ/ì†Œí™”/ì‹ ê²½
    "w_melena": 1.0, "w_hematochezia": 1.0, "w_persistent_vomit": 1.0, "w_oliguria": 1.0,
    "w_petechiae": 1.0, "w_thunderclap": 1.0, "w_visual_change": 1.0, "w_chest_pain": 1.0,
}

def get_weights():
    if "weights" not in st.session_state:
        st.session_state["weights"] = dict(DEFAULT_WEIGHTS)
    return st.session_state["weights"]

def set_weights(W: dict):
    st.session_state["weights"] = dict(W)

# ======================================================
#      Pediatric score-based caregiver guidance
# ======================================================
def render_peds_score_guidance(score: dict | None, *, max_temp=None):
    """ì ìˆ˜ dict(í•œê¸€ ì¹´í…Œê³ ë¦¬ í‚¤)ë¥¼ ë†’ìŒ/ë³´í†µ/ë‚®ìŒìœ¼ë¡œ ë¬¶ì–´ ê°€ì •ê´€ë¦¬/ë³‘ì›ê¸°ì¤€ ì•ˆë‚´.
       í‚¤ ì˜ˆì‹œ: "ì¥ì—¼ ì˜ì‹¬","ìƒê¸°ë„/ë…ê° ê³„ì—´","ê²°ë§‰ì—¼ ì˜ì‹¬","íƒˆìˆ˜/ì‹ ì¥ ë¬¸ì œ","ì¶œí˜ˆì„± ê²½í–¥",
               "ì¤‘ì´ì—¼/ê·€ì§ˆí™˜","í”¼ë¶€ë°œì§„/ê²½ë¯¸í•œ ì•Œë ˆë¥´ê¸°","ë³µí†µ í‰ê°€","ì•Œë ˆë¥´ê¸° ì£¼ì˜","í¸ë‘í†µ ì˜ì‹¬","ìˆ˜ì¡±êµ¬ ì˜ì‹¬"
    """
    import math
    if not isinstance(score, dict) or not score:
        st.caption("ì¦ìƒ ì ìˆ˜ ì •ë³´ê°€ ì—†ì–´ ê¸°ë³¸ ì„¤ëª…ë§Œ ì œê³µí•©ë‹ˆë‹¤.")
        return

    HIGH, MID = 2.0, 1.0
    tiers = {"ë†’ìŒ": [], "ë³´í†µ": [], "ë‚®ìŒ": []}

    def add(title, home_tips, visit_rules, level): tiers[level].append((title, home_tips, visit_rules))
    def level_of(v): return "ë†’ìŒ" if v >= HIGH else ("ë³´í†µ" if v >= MID else "ë‚®ìŒ")

    mapping = [
        ("ì¥ì—¼ ì˜ì‹¬","ì¥ì—¼ ì˜ì‹¬",
         ["ğŸ¥¤ ORS 5â€“10ë¶„ ê°„ê²© ì†ŒëŸ‰ì”©", "ê¸°ë¦„ì§„ ìŒì‹Â·ìƒì•¼ì±„Â·ìš°ìœ  ì¼ì‹œ ì œí•œ", "êµ¬í†  ë©ìœ¼ë©´ ì–‘ ì„œì„œíˆ ì¦ëŸ‰", "í•­ë¬¸ ì£¼ìœ„ ë¯¸ì˜¨ìˆ˜ ì„¸ì • í›„ ê±´ì¡°Â·ë³´ìŠµë§‰"],
         ["í˜ˆë³€/í‘ìƒ‰ë³€Â·ì§€ì† êµ¬í† Â·2ì‹œê°„â†‘ ë¬´ë‡¨ëŠ” ë³‘ì›", "ì¶• ì²˜ì§/ì…ë§ˆë¦„/ëˆˆë¬¼â†“ ë“± íƒˆìˆ˜ ì˜ì‹¬ ì‹œ ì§„ë£Œ"]),
        ("ìƒê¸°ë„/ë…ê° ê³„ì—´","ìƒê¸°ë„/ë…ê° ê³„ì—´",
         ["ê°€ìŠµÂ·í†µí’Â·ë¯¸ì˜¨ìˆ˜ ìƒ¤ì›Œ", "ìƒë¦¬ì‹ì—¼ìˆ˜ ë¶„ë¬´(ì†Œì•„)", "ìˆ˜ë©´ ì‹œ ë¨¸ë¦¬ ì•½ê°„ ë†’ì´ê¸°", "í•´ì—´ì œ ê°„ê²© ì¤€ìˆ˜(APAPâ‰¥4h, IBUâ‰¥6h)"],
         ["í˜¸í¡ê³¤ë€Â·ì²­ìƒ‰ì¦ì€ ì¦‰ì‹œ ë³‘ì›", "2ì£¼â†‘ ê¸°ì¹¨ ë˜ëŠ” í‰í†µ/ìŒ•ìŒ•ê±°ë¦¼ ë™ë°˜ ì‹œ ì§„ë£Œ"]),
        ("ê²°ë§‰ì—¼ ì˜ì‹¬","ê²°ë§‰ì—¼ ì˜ì‹¬",
         ["ë¯¸ì˜¨ìˆ˜ë¡œ ì•ˆâ†’ë°”ê¹¥ ë‹¦ê¸°(1íšŒ 1ê±°ì¦ˆ)", "ì† ìœ„ìƒ, ìˆ˜ê±´Â·ë² ê°œ ê³µìœ  ê¸ˆì§€"],
         ["ê´‘ê³¼ë¯¼/í†µì¦Â·ë¶€ì¢… ì‹¬í•˜ë©´ ì§„ë£Œ", "ë†ì„± ë¶„ë¹„ë¬¼+ê³ ì—´ì´ë©´ ë³‘ì›"]),
        ("íƒˆìˆ˜/ì‹ ì¥ ë¬¸ì œ","íƒˆìˆ˜/ì‹ ì¥ ë¬¸ì œ",
         ["ìˆ˜ë¶„/ORS ìì£¼ ì¡°ê¸ˆì”© ë³´ì¶©", "ì†Œë³€ ì–‘Â·ìƒ‰/ì²´ì¤‘ ê¸°ë¡", "ê³ ì—´ ì‹œ ë¯¸ì˜¨ìˆ˜ ë‹¦ê¸°Â·íœ´ì‹"],
         ["2ì‹œê°„â†‘ ë¬´ë‡¨, ì…ë§ˆë¦„/ëˆˆë¬¼â†“ì€ ë³‘ì›", "ì–´ì§€ëŸ¼/ë¬´ê¸°ë ¥ ì‹¬í•˜ë©´ ì§„ë£Œ"]),
        ("ì¶œí˜ˆì„± ê²½í–¥","ì¶œí˜ˆì„± ê²½í–¥",
         ["ê°•í•œ ë§ˆì°°Â·ë”±ë”±í•œ ìŒì‹Â·ì„¸ê²Œ ì½”í’€ê¸° ì¤„ì´ê¸°", "ë¶€ë“œëŸ¬ìš´ ì¹«ì†” ì‚¬ìš©"],
         ["ì§€ì† ì½”í”¼/ì‡ëª¸ì¶œí˜ˆÂ·í‘ìƒ‰ë³€/í˜ˆë³€ì€ ë³‘ì›", "í° ë©ì´ ì‰½ê²Œ ìƒê¸°ë©´ ì§„ë£Œ"]),
        ("ì¤‘ì´ì—¼/ê·€ì§ˆí™˜","ì¤‘ì´ì—¼/ê·€ì§ˆí™˜",
         ["ëˆ„ìš°ë©´ ì•…í™” â†’ ë¨¸ë¦¬ ì•½ê°„ ë†’ì—¬ ìˆ˜ë©´", "ë¹„ì—¼ ê´€ë¦¬(ìƒë¦¬ì‹ì—¼ìˆ˜Â·ê°€ìŠµ)"],
         ["ê³ ì—´Â·êµ¬í†  ë™ë°˜/48hâ†‘ í†µì¦ ì§€ì† ì‹œ ì§„ë£Œ", "ê·€ ë’¤ ë¶“ê³  ì‹¬í†µì¦ì€ ì¦‰ì‹œ ë³‘ì›"]),
        ("í”¼ë¶€ë°œì§„/ê²½ë¯¸í•œ ì•Œë ˆë¥´ê¸°","í”¼ë¶€ë°œì§„/ê²½ë¯¸í•œ ì•Œë ˆë¥´ê¸°",
         ["ì‹œì›í•œ í™˜ê²½Â·ë§ˆì°° ì¤„ì´ê¸°Â·ë³´ìŠµ", "ì˜ì‹¬ ìŒì‹/ì•½ë¬¼ ì¼ì‹œ ì¤‘ë‹¨Â·ê¸°ë¡"],
         ["ì–¼êµ´Â·ì…ìˆ Â·í˜€ ë¶“ê¸°/í˜¸í¡ê³¤ë€ì€ ì¦‰ì‹œ ë³‘ì›", "ìˆ˜í¬Â·ê³ ì—´ ë™ë°˜ ì „ì‹  ë°œì§„ì€ ì§„ë£Œ"]),
        ("ë³µí†µ í‰ê°€","ë³µí†µ í‰ê°€",
         ["ë³µë¶€ ë”°ëœ»í•˜ê²ŒÂ·ìê·¹ì  ìŒì‹ ì œí•œ", "í†µì¦ ìœ„ì¹˜/ì‹œê°„/ì‹ì‚¬Â·ë°°ë³€ ì—°ê´€ ê¸°ë¡"],
         ["ìš°í•˜ë³µë¶€ ì§€ì† í†µì¦/ë³´í–‰ ì•…í™”/êµ¬í† Â·ë°œì—´ ë™ë°˜ì€ ì¦‰ì‹œ ì§„ë£Œ", "ë³µë¶€ íŒ½ë§ŒÂ·í˜ˆë³€/í‘ìƒ‰ë³€ ë™ë°˜ì€ ë³‘ì›"]),
        ("ì•Œë ˆë¥´ê¸° ì£¼ì˜","ì•Œë ˆë¥´ê¸° ì£¼ì˜",
         ["ì˜ì‹¬ ìŒì‹/ì•½ë¬¼ ì¤‘ë‹¨", "ì‹œì›í•œ í™˜ê²½Â·ë³´ìŠµÂ·ëƒ‰ì°œì§ˆ"],
         ["í˜¸í¡ê³¤ë€/ì–¼êµ´Â·ì…ìˆ Â·í˜€ ë¶“ê¸°/ì „ì‹  ë‘ë“œëŸ¬ê¸°ëŠ” ì¦‰ì‹œ ë³‘ì›"]),
        ("í¸ë‘í†µ ì˜ì‹¬","í¸ë‘í†µ ì˜ì‹¬",
         ["ì–´ë‘ìš´ ì¡°ìš©í•œ í™˜ê²½Â·ìˆ˜ë¶„ ë³´ì¶©", "ì§„í†µì œ ê°„ê²© ì—„ìˆ˜(ì¤‘ë³µ ì£¼ì˜)"],
         ["ë²ˆê°œë‘í†µÂ·ì‹ ê²½í•™ì  ì´ìƒì€ ì¦‰ì‹œ ë³‘ì›", "ì ì°¨ ì•…í™”Â·êµ¬í† /ì‹œì•¼ ì´ìƒ ë™ë°˜ ì‹œ ì§„ë£Œ"]),
        ("ìˆ˜ì¡±êµ¬ ì˜ì‹¬","ìˆ˜ì¡±êµ¬ ì˜ì‹¬",
         ["ì°¨ê°‘ê±°ë‚˜ ë¯¸ì§€ê·¼í•œ ë¶€ë“œëŸ¬ìš´ ìŒì‹", "ìˆ˜ë¶„ ë³´ì¶©Â·ë¶€ë“œëŸ¬ìš´ ì–‘ì¹˜"],
         ["ì„­ì·¨ ê±°ë¶€/ì¹¨ í˜ë¦¼ ì‹¬í•˜ë©´ ë³‘ì›", "ê³ ì—´ 3ì¼â†‘Â·ë¬´ê¸°ë ¥ ì‹¬í•˜ë©´ ì§„ë£Œ"]),
    ]

    # ì ìˆ˜â†’ë ˆë²¨ ë¶„ë¥˜
    for key, title, home_tips, visit_rules in mapping:
        v = float(score.get(key, 0) or 0)
        lvl = "ë†’ìŒ" if v >= HIGH else ("ë³´í†µ" if v >= MID else "ë‚®ìŒ")
        tiers[lvl].append((title, home_tips, visit_rules))

    # ìµœê³  ì²´ì˜¨ ë³´ì •
    if max_temp is not None:
        try:
            mt = float(max_temp)
            if mt >= 39.0:
                tiers["ë†’ìŒ"].insert(0, ("ìµœê³  ì²´ì˜¨", [], [f"í˜„ì¬ ìµœê³  {mt:.1f}â„ƒ â†’ ì¦‰ì‹œ ë³‘ì› ê¶Œê³  ìˆ˜ì¤€ì…ë‹ˆë‹¤."]))
            elif mt >= 38.5:
                tiers["ë³´í†µ"].insert(0, ("ìµœê³  ì²´ì˜¨", [], [f"í˜„ì¬ ìµœê³  {mt:.1f}â„ƒ â†’ í•´ì—´/ìˆ˜ë¶„ ë³´ì¶© í›„ ë©´ë°€ ê´€ì°° í•„ìš”."]))
        except Exception:
            pass

    # ì €í˜¸ì¤‘êµ¬ ì‹í’ˆì•ˆì „(ìˆìœ¼ë©´ ìƒë‹¨)
    try:
        anc_val = float(str(st.session_state.get("labs_dict", {}).get("ANC", "")).replace(",", "."))
    except Exception:
        anc_val = None
    if anc_val is not None and anc_val < 1000:
        tiers["ë†’ìŒ"].insert(0, ("ì €í˜¸ì¤‘êµ¬ ìŒì‹ ì•ˆì „",
            ["ìƒì•¼ì±„/ê»ì§ˆ ê³¼ì¼ í”¼í•˜ê¸°Â·**ì™„ì „ ê°€ì—´**", "ë‚¨ì€ ìŒì‹ **2ì‹œê°„ ì´í›„ ë¹„ê¶Œì¥**, ë©¸ê· Â·ì‚´ê·  ì‹í’ˆ ê¶Œì¥"],
            ["38.0â„ƒâ†‘ ë°œì—´ ì‹œ ë³‘ì› ì—°ë½, 38.5~39â„ƒ ì´ìƒì€ ìƒìœ„ ì¡°ì¹˜"]))

    with st.expander("ğŸ‘ª ì¦ìƒ ì ìˆ˜ ê¸°ë°˜ ë³´í˜¸ì ê°€ì´ë“œ", expanded=False):
        for lvl in ["ë†’ìŒ", "ë³´í†µ", "ë‚®ìŒ"]:
            items = tiers[lvl]
            if not items: 
                continue
            st.markdown(f"### {lvl} ìš°ì„  ìˆœìœ„")
            for title, home_tips, visit_rules in items:
                st.markdown(f"**{title}**")
                if home_tips:
                    st.markdown("ê°€ì • ê´€ë¦¬")
                    for x in home_tips: st.markdown(f"- {x}")
                if visit_rules:
                    st.markdown("ë³‘ì› ë°©ë¬¸ ê¸°ì¤€")
                    for x in visit_rules: st.markdown(f"- {x}")
                st.markdown("---")

# ======================================================
#          Expert sliders panel (wrapped in expander)
# ======================================================
def render_expert_sliders():
    W = get_weights()
    grid = [
        ("ANC<500", "w_anc_lt500"),
        ("ANC 500~999", "w_anc_500_999"),
        ("ë°œì—´ 38.0~38.4", "w_temp_38_0_38_4"),
        ("ê³ ì—´ â‰¥38.5", "w_temp_ge_38_5"),
        ("í˜ˆì†ŒíŒ <20k", "w_plt_lt20k"),
        ("ì¤‘ì¦ë¹ˆí˜ˆ Hb<7", "w_hb_lt7"),
        ("CRP â‰¥10", "w_crp_ge10"),
        ("HR>130", "w_hr_gt130"),
        ("í˜ˆë‡¨", "w_hematuria"),
        ("í‘ìƒ‰ë³€", "w_melena"),
        ("í˜ˆë³€", "w_hematochezia"),
        ("í‰í†µ", "w_chest_pain"),
        ("í˜¸í¡ê³¤ë€", "w_dyspnea"),
        ("ì˜ì‹ì €í•˜", "w_confusion"),
        ("ì†Œë³€ëŸ‰ ê¸‰ê°", "w_oliguria"),
        ("ì§€ì† êµ¬í† ", "w_persistent_vomit"),
        ("ì ìƒì¶œí˜ˆ", "w_petechiae"),
        ("ë²ˆê°œë‘í†µ", "w_thunderclap"),
        ("ì‹œì•¼ ì´ìƒ", "w_visual_change"),
    ]
    cols = st.columns(3)
    newW = dict(W)
    for i, (label, keyid) in enumerate(grid):
        with cols[i % 3]:
            newW[keyid] = st.slider(label, 0.0, 3.0, float(W.get(keyid, 1.0)), 0.1, key=f"sl_{keyid}")
    if newW != W:
        set_weights(newW)
        st.success("ê°€ì¤‘ì¹˜ ë³€ê²½ ì‚¬í•­ ì €ì¥ë¨.")

# ======================================================
#                 HOME (ì´ˆë³´ì + ì „ë¬¸ê°€)
# ======================================================
with t_home:
    st.header("í™ˆ")
    st.subheader("ì‘ê¸‰ë„ ê°€ì¤‘ì¹˜")
    st.caption("ì´ˆë³´ììš©ì€ ìœ„ì—ì„œ ê°„ë‹¨í•˜ê²Œ, ì „ë¬¸ê°€ìš©ì€ ì•„ë˜ì—ì„œ ì„¸ë°€í•˜ê²Œ ì¡°ì •í•©ë‹ˆë‹¤. ê¸°ì¡´ ê³„ì‚° ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.")

    # --- ğŸ”° ì´ˆë³´ììš© ê°„ë‹¨ ì„¤ì • ---
    st.markdown("#### ğŸ”° ì´ˆë³´ììš© ê°„ë‹¨ ì„¤ì •")
    st.caption("ì–´ë ¤ìš°ë©´ ì´ ë¶€ë¶„ë§Œ ì¡°ì •í•´ë„ ì¶©ë¶„í•©ë‹ˆë‹¤. ì„¸ë°€í•œ ê°’ì€ ì•„ë˜ 'ì „ë¬¸ê°€ìš©'ì—ì„œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.")
    W_simple = dict(get_weights())

    def _apply_group(level, keys, base=1.0):
        mapping = {"ë‚®ìŒ": 0.9, "ë³´í†µ": 1.0, "ë†’ìŒ": 1.2}
        w = mapping.get(level, 1.0)
        for k in keys:
            W_simple[k] = round(base * w, 2)

    colS1, colS2, colS3 = st.columns(3)
    with colS1:
        inf_lvl = st.select_slider("ë°œì—´Â·ê°ì—¼ ë¯¼ê°ë„", options=["ë‚®ìŒ","ë³´í†µ","ë†’ìŒ"], value="ë³´í†µ",
                                   help="ê³ ì—´/CRP/í˜¸ì¤‘êµ¬ ê°ì†Œì— ëŒ€í•œ ê°€ì¤‘ì¹˜")
    with colS2:
        bleed_lvl = st.select_slider("ì¶œí˜ˆ ìœ„í—˜ ë¯¼ê°ë„", options=["ë‚®ìŒ","ë³´í†µ","ë†’ìŒ"], value="ë³´í†µ",
                                     help="í˜ˆì†ŒíŒ ê°ì†Œ/ì¶œí˜ˆ ì§•í›„ì— ëŒ€í•œ ê°€ì¤‘ì¹˜")
    with colS3:
        neuro_lvl = st.select_slider("ì‹ ê²½Â·í˜¸í¡ ë¯¼ê°ë„", options=["ë‚®ìŒ","ë³´í†µ","ë†’ìŒ"], value="ë³´í†µ",
                                     help="ì˜ì‹ì €í•˜/í‰í†µ/í˜¸í¡ê³¤ë€/ë²ˆê°œë‘í†µ/ì‹œì•¼ì´ìƒ")

    _apply_group(inf_lvl,   ["w_temp_ge_38_5","w_temp_38_0_38_4","w_crp_ge10","w_anc_lt500","w_anc_500_999"])
    _apply_group(bleed_lvl, ["w_plt_lt20k","w_petechiae","w_melena","w_hematochezia"])
    _apply_group(neuro_lvl, ["w_confusion","w_chest_pain","w_dyspnea","w_thunderclap","w_visual_change","w_hr_gt130"])

    if W_simple != get_weights():
        set_weights(W_simple)
        st.success("ì´ˆë³´ììš© ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.")

    st.markdown("---")
    with st.expander("ì „ë¬¸ê°€ìš© ì„¸ë°€ ì¡°ì •(ìŠ¬ë¼ì´ë”)", expanded=False):
        render_expert_sliders()

# ======================================================
#                 PEDS (ì ìˆ˜ ê°€ì´ë“œ)
# ======================================================
with t_peds:
    st.header("ì†Œì•„")
    st.caption("ì†Œì•„ ë³´í˜¸ì ê°€ì´ë“œëŠ” ì ìˆ˜(score)ì™€ ìµœê³  ì²´ì˜¨ì„ ê¸°ì¤€ìœ¼ë¡œ ì¹œì ˆí•˜ê²Œ ì •ë¦¬ë©ë‹ˆë‹¤.")

    # ê¸°ì¡´ ì•±ì—ì„œ ë§Œë“  score / max_tempê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
    score = st.session_state.get("peds_score") or {}
    max_temp = st.session_state.get("max_temp")

    # ì ìˆ˜ê°€ ì „í˜€ ì—†ì„ ë•Œë¥¼ ëŒ€ë¹„í•œ ê°€ë²¼ìš´ ì…ë ¥(ì›ë³¸ ì•±ì—” ì˜í–¥ ì—†ìŒ)
    with st.expander("ì ìˆ˜ ì…ë ¥(ì—†ìœ¼ë©´ ê±´ë„ˆëœ€)", expanded=False):
        if not score:
            # í•œêµ­ì–´ ì¹´í…Œê³ ë¦¬ í‚¤ ì´ˆê¸° í…œí”Œë¦¿
            init = {
                "ì¥ì—¼ ì˜ì‹¬": 0, "ìƒê¸°ë„/ë…ê° ê³„ì—´": 0, "ê²°ë§‰ì—¼ ì˜ì‹¬": 0, "íƒˆìˆ˜/ì‹ ì¥ ë¬¸ì œ": 0, "ì¶œí˜ˆì„± ê²½í–¥": 0,
                "ì¤‘ì´ì—¼/ê·€ì§ˆí™˜": 0, "í”¼ë¶€ë°œì§„/ê²½ë¯¸í•œ ì•Œë ˆë¥´ê¸°": 0, "ë³µí†µ í‰ê°€": 0, "ì•Œë ˆë¥´ê¸° ì£¼ì˜": 0, "í¸ë‘í†µ ì˜ì‹¬": 0, "ìˆ˜ì¡±êµ¬ ì˜ì‹¬": 0
            }
            cols = st.columns(3)
            new_score = {}
            items = list(init.items())
            for i, (k, _) in enumerate(items):
                with cols[i % 3]:
                    new_score[k] = st.slider(k, 0.0, 3.0, 0.0, 0.5, key=f"ps_{k}")
            score = new_score
        if max_temp is None:
            max_temp = st.number_input("ìµœê³  ì²´ì˜¨(Â°C)", min_value=34.0, max_value=43.5, step=0.1, format="%.1f")

    # ê°€ì´ë“œ ë Œë”
    try:
        render_peds_score_guidance(score, max_temp=max_temp)
    except Exception as _e:
        st.caption(f"ì ìˆ˜ ê°€ì´ë“œ ë¡œë”© ì¤‘: {_e}")

# ======================================================
#              LABS / REPORT / OTHERS (placeholders)
# ======================================================
with t_labs:
    st.header("ê²€ì‚¬ê²°ê³¼")
    st.caption("ê¸°ì¡´ í”¼ìˆ˜ì¹˜(ë©) UIë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”. ë³¸ íŒŒì¼ì€ íƒ­ ì•ˆì „í™”ë§Œ ì œê³µí•˜ë©°, ê¸°ì¡´ ì½”ë“œë¥¼ ì‚­ì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    # ê¸°ì¡´ ì•±ì—ì„œ labs_dict ë“±ì„ ì„¸ì…˜ì— ì €ì¥í•˜ë©´ ê·¸ëŒ€ë¡œ í™œìš©ë©ë‹ˆë‹¤.
with t_report:
    st.header("ë³´ê³ ì„œ")
    st.caption("ê¸°ì¡´ ë³´ê³ ì„œ ìƒì„± ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”. (ì—¬ê¸°ì„œëŠ” ì‚­ì œ/ë³€ê²½í•˜ì§€ ì•ŠìŒ)")
with t_meds:
    st.header("ë³µì•½/ìš©ë²•")
    st.caption("ê¸°ì¡´ ì•½ë¬¼/ìš©ë²• UIë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.")
with t_dx:
    st.header("ì§„ë‹¨")
    st.caption("ê¸°ì¡´ ì•” ê´€ë ¨ í‰ê°€/ì˜ì‚¬ê²°ì • ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”. (íƒ­ NameErrorë§Œ ë°©ì§€)")
with t_edu:
    st.header("êµìœ¡/ê°€ì´ë“œ")
    st.caption("ê¸°ì¡´ êµìœ¡ìë£Œ/ê°€ì´ë“œ UI ê·¸ëŒ€ë¡œ.")
with t_settings:
    st.header("ì„¤ì •")
    st.caption("í™˜ê²½ ì„¤ì •/í”„ë¦¬ì…‹ ë“± ê¸°ì¡´ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.")
